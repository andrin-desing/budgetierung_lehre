<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lehrlings-Budget</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Dark Mode styles */
        html.dark .bg-white { background-color: #2D3748; }
        html.dark .text-gray-900 { color: #E2E8F0; }
        html.dark .text-gray-800 { color: #E2E8F0; }
        html.dark .text-gray-700 { color: #CBD5E0; }
        html.dark .text-gray-600 { color: #A0AEC0; }
        html.dark .text-gray-500 { color: #718096; }
        html.dark .border-\[\#8B9D77\] { border-color: #37745B; } /* mediumGreen for dark mode border */
        html.dark .bg-\[\#E7EAEF\] { background-color: #2D3748; } /* lightGrayBlue for dark mode card background */
        html.dark .bg-\[\#EDC5AB\] { background-color: #37745B; } /* lightBeige for dark mode income/list items */
        html.dark .bg-\[\#217074\] { background-color: #37745B; } /* darkBlueGreen for dark mode header/buttons */
        html.dark .bg-\[\#37745B\] { background-color: #217074; } /* darkGreen for dark mode active buttons/income summary */
        html.dark .hover\:bg-\[\#8B9D77\]:hover { background-color: #8B9D77; } /* mediumGreen hover for dark mode */
        html.dark .hover\:bg-\[\#37745B\]:hover { background-color: #217074; } /* darkGreen hover for dark mode */
        html.dark .text-\[\#217074\] { color: #E2E8F0; } /* darkBlueGreen text for dark mode */
        html.dark .text-\[\#37745B\] { color: #E2E8F0; } /* darkGreen text for dark mode */
        html.dark .bg-red-100 { background-color: #FED7D7; } /* Red error background */
        html.dark .text-red-700 { color: #FC8181; } /* Red error text */
        html.dark .bg-yellow-100 { background-color: #FEFCBF; } /* Yellow warning background */
        html.dark .text-yellow-600 { color: #F6E05E; } /* Yellow warning text */
        html.dark .bg-gray-700 { background-color: #4A5568; } /* Input background in dark mode */
        html.dark .border-gray-600 { border-color: #4A5568; } /* Input border in dark mode */
        html.dark .focus\:ring-gray-500:focus { --tw-ring-color: #6B7280; } /* Input focus ring in dark mode */
        html.dark .text-white { color: #E2E8F0; } /* Ensure white text remains visible */
    </style>
</head>
<body class="min-h-screen bg-[#E7EAEF] text-gray-900 font-inter">

    <!-- Header -->
    <header class="p-4 shadow-md rounded-b-lg bg-[#217074] text-white">
        <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-3xl font-bold mb-2 sm:mb-0">Lehrlings-Budget</h1>
            <nav class="w-full sm:w-auto">
                <ul class="flex flex-wrap justify-center sm:justify-end gap-2 sm:space-x-4">
                    <li><button id="dashboard-btn" class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-sm sm:text-base transition-colors duration-200">Dashboard</button></li>
                    <li><button id="categories-btn" class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-sm sm:text-base transition-colors duration-200">Kategorien</button></li>
                    <li><button id="settings-btn" class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-sm sm:text-base transition-colors duration-200">Einstellungen</button></li>
                    <li><button id="limits-btn" class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-sm sm:text-base transition-colors duration-200">Budgetgrenzen</button></li>
                    <li><button id="invoice-upload-btn" class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-sm sm:text-base transition-colors duration-200">Rechnungen hochladen</button></li>
                    <li><button id="logout-btn" class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-sm sm:text-base bg-red-500 hover:bg-red-600 transition-colors duration-200">Abmelden</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Hauptinhalt -->
    <main id="main-content" class="container mx-auto p-4 sm:p-6">
        <!-- Inhalte werden hier dynamisch geladen -->
    </main>

    <!-- Dark Mode Button -->
    <button id="dark-mode-toggle" class="fixed bottom-4 right-4 p-3 rounded-full shadow-lg transition-colors duration-300 bg-[#217074] text-white" aria-label="Toggle Dark Mode">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
        </svg>
    </button>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, deleteDoc, onSnapshot, query, where, orderBy, serverTimestamp, getDocs, writeBatch, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Deine Firebase Konfiguration
        const firebaseConfig = {
          apiKey: "AIzaSyBX_aHaadvBz08hcVUz-_qLVP0a16N3R3s",
          authDomain: "budgettierung-lehre.firebaseapp.com",
          projectId: "budgettierung-lehre",
          storageBucket: "budgettierung-lehre.firebasestorage.app",
          messagingSenderId: "993511841399",
          appId: "1:993511841399:web:811a030fa95465af20b072",
          measurementId: "G-M2MV5B2SDT"
        };

        // Die App ID wird aus der Firebase Konfiguration extrahiert
        const appId = firebaseConfig.appId || 'default-app-id';

        let app;
        let auth;
        let db;
        let currentUser = null;
        let currentUserId = null;
        let isAuthReady = false;
        let currentCategories = []; // Globaler Cache für Kategorien
        let darkMode = false; // Globaler State für Dark Mode

        // Farbpalette
        const colors = {
            darkBlueGreen: '#217074',
            darkGreen: '#37745B',
            mediumGreen: '#8B9D77',
            lightGrayBlue: '#E7EAEF',
            lightBeige: '#EDC5AB',
            darkBackground: '#1A202C',
            darkCardBackground: '#2D3748',
            darkText: '#E2E8F0',
        };

        // DOM-Elemente
        const mainContent = document.getElementById('main-content');
        const dashboardBtn = document.getElementById('dashboard-btn');
        const categoriesBtn = document.getElementById('categories-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const limitsBtn = document.getElementById('limits-btn');
        const invoiceUploadBtn = document.getElementById('invoice-upload-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const headerNavButtons = [dashboardBtn, categoriesBtn, settingsBtn, limitsBtn, invoiceUploadBtn, logoutBtn];

        // --- Hilfsfunktionen für UI-Updates ---
        function applyDarkModeStyles() {
            if (darkMode) {
                document.documentElement.classList.add('dark');
                darkModeToggle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h1M4 12H3m15.325 5.325l-.707.707M6.364 6.364l-.707-.707m12.728 0l-.707-.707M6.364 17.636l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                                            </svg>`;
                darkModeToggle.classList.remove(`bg-[${colors.darkBlueGreen}]`, 'text-white', `hover:bg-[${colors.darkGreen}]`);
                darkModeToggle.classList.add(`bg-[${colors.darkGreen}]`, `text-[${colors.darkText}]`, `hover:bg-[${colors.darkBlueGreen}]`);
            } else {
                document.documentElement.classList.remove('dark');
                darkModeToggle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                                            </svg>`;
                darkModeToggle.classList.remove(`bg-[${colors.darkGreen}]`, `text-[${colors.darkText}]`, `hover:bg-[${colors.darkBlueGreen}]`);
                darkModeToggle.classList.add(`bg-[${colors.darkBlueGreen}]`, 'text-white', `hover:bg-[${colors.darkGreen}]`);
            }
        }

        function updateHeaderNavButtons(activePageId) {
            headerNavButtons.forEach(button => {
                if (button.id.startsWith(activePageId)) {
                    button.classList.add(darkMode ? `bg-[${colors.darkGreen}]` : `bg-[${colors.darkGreen}]`);
                    button.classList.remove(darkMode ? `hover:bg-[${colors.mediumGreen}]` : `hover:bg-[${colors.mediumGreen}]`);
                } else {
                    button.classList.remove(darkMode ? `bg-[${colors.darkGreen}]` : `bg-[${colors.darkGreen}]`);
                    button.classList.add(darkMode ? `hover:bg-[${colors.mediumGreen}]` : `hover:bg-[${colors.mediumGreen}]`);
                }
            });
        }

        function getCardClasses() {
            return `p-6 sm:p-8 rounded-xl shadow-lg border ${darkMode ? `bg-[${colors.darkCardBackground}] border-[${colors.darkGreen}] text-[${colors.darkText}]` : `bg-white border-[${colors.mediumGreen}] text-gray-900`}`;
        }

        function getInnerCardClasses() {
            return `mb-8 p-4 sm:p-6 rounded-lg border ${darkMode ? `bg-[${colors.darkCardBackground}] border-[${colors.darkGreen}]` : `bg-[${colors.lightGrayBlue}] border-[${colors.mediumGreen}]`}`;
        }

        function getInputClasses() {
            return `shadow appearance-none border rounded-lg w-full py-2.5 px-3 sm:py-3 sm:px-4 leading-tight focus:outline-none focus:ring-2 ${darkMode ? `bg-gray-700 text-white border-gray-600 focus:ring-gray-500` : `bg-white text-gray-700 border-[${colors.mediumGreen}] focus:ring-[${colors.mediumGreen}]`}`;
        }

        function getButtonClasses(baseColor, hoverColor) {
            return `font-bold py-2.5 px-5 sm:py-3 sm:px-6 rounded-lg text-base sm:text-lg focus:outline-none focus:shadow-outline transition-all duration-200 transform hover:scale-105 ${darkMode ? `bg-[${baseColor}] hover:bg-[${hoverColor}] text-[${colors.darkText}]` : `bg-[${baseColor}] hover:bg-[${hoverColor}] text-white`}`;
        }

        function getLabelClasses() {
            return `block text-sm font-semibold mb-2 ${darkMode ? `text-[${colors.darkText}]` : 'text-gray-700'}`;
        }

        function getTitleClasses() {
            return `text-2xl sm:text-3xl font-bold mb-6 text-center ${darkMode ? `text-[${colors.darkText}]` : `text-gray-800`}`;
        }

        function getSubtitleClasses() {
            return `text-xl font-semibold mb-4 ${darkMode ? `text-[${colors.darkText}]` : `text-[${colors.darkGreen}]`}`;
        }

        function getItalicTextClasses() {
            return `italic ${darkMode ? `text-gray-400` : `text-gray-600`}`;
        }

        function getListItemClasses() {
            return `flex items-center justify-between p-4 rounded-md shadow-sm border ${darkMode ? `bg-gray-700 border-gray-600 text-[${colors.darkText}]` : `bg-[${colors.lightBeige}] border-[${colors.mediumGreen}] text-gray-900`}`;
        }

        function getIncomeTextClasses() {
            return `text-lg font-medium ${darkMode ? `text-[${colors.darkText}]` : `text-[${colors.darkGreen}]`}`;
        }

        function getExpenseTextClasses() {
            return `text-lg font-medium text-red-600`;
        }

        function getSmallTextClasses() {
            return `text-sm ${darkMode ? `text-gray-300` : `text-gray-700`}`;
        }

        function getXSmallTextClasses() {
            return `text-xs ${darkMode ? `text-gray-400` : `text-gray-500`}`;
        }

        // --- Allgemeine App-Logik ---
        async function renderPage(pageName) {
            mainContent.innerHTML = ''; // Inhalt leeren
            updateHeaderNavButtons(pageName); // Header-Buttons aktualisieren

            if (!currentUser && pageName !== 'login') {
                renderLoginPage();
                return;
            }

            switch (pageName) {
                case 'login':
                    renderLoginPage();
                    break;
                case 'dashboard':
                    await renderDashboardPage();
                    break;
                case 'categories':
                    await renderCategoriesPage();
                    break;
                case 'settings':
                    await renderSettingsPage();
                    break;
                case 'limits':
                    await renderBudgetLimitsPage();
                    break;
                case 'invoice-upload':
                    renderInvoiceUploadPage();
                    break;
                default:
                    renderLoginPage();
            }
        }

        // --- Auth-Seite ---
        function renderLoginPage() {
            let email = '';
            let password = '';
            let isRegistering = false;
            let errorMessage = '';
            let loading = false;

            const updateUI = () => {
                mainContent.innerHTML = `
                    <div class="${getCardClasses()} max-w-md mx-auto">
                        <h2 class="${getTitleClasses()}">
                            ${isRegistering ? 'Registrieren' : 'Anmelden'}
                        </h2>
                        ${errorMessage ? `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md relative mb-4" role="alert">
                            <strong class="font-bold">Fehler!</strong>
                            <span class="block sm:inline"> ${errorMessage}</span>
                        </div>` : ''}
                        <div class="mb-4">
                            <label class="${getLabelClasses()}" for="email">E-Mail</label>
                            <input type="email" id="email" class="${getInputClasses()}" placeholder="deine.email@example.com" value="${email}" ${loading ? 'disabled' : ''}>
                        </div>
                        <div class="mb-6">
                            <label class="${getLabelClasses()}" for="password">Passwort</label>
                            <input type="password" id="password" class="${getInputClasses()}" placeholder="********" value="${password}" ${loading ? 'disabled' : ''}>
                        </div>
                        <div class="flex flex-col space-y-3 sm:space-y-4">
                            <button id="auth-action-btn" class="${getButtonClasses(darkMode ? colors.darkGreen : colors.darkBlueGreen, darkMode ? colors.darkBlueGreen : colors.darkGreen)}" ${loading ? 'disabled' : ''}>
                                ${loading ? 'Lade...' : (isRegistering ? 'Registrieren' : 'Anmelden')}
                            </button>
                            <button id="toggle-register-btn" class="${getButtonClasses(darkMode ? 'gray-700' : colors.lightGrayBlue, darkMode ? 'gray-600' : 'gray-300')}" ${loading ? 'disabled' : ''}>
                                ${isRegistering ? 'Ich habe bereits ein Konto' : 'Ich habe noch kein Konto'}
                            </button>
                        </div>
                    </div>
                `;

                document.getElementById('email').oninput = (e) => { email = e.target.value; };
                document.getElementById('password').oninput = (e) => { password = e.target.value; };
                document.getElementById('auth-action-btn').onclick = handleAuthAction;
                document.getElementById('toggle-register-btn').onclick = () => {
                    isRegistering = !isRegistering;
                    errorMessage = '';
                    updateUI();
                };
            };

            const handleAuthAction = async () => {
                loading = true;
                errorMessage = '';
                updateUI(); // UI aktualisieren, um Ladezustand anzuzeigen

                try {
                    if (isRegistering) {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        currentUser = userCredential.user;
                        currentUserId = userCredential.user.uid;
                        renderPage('dashboard');
                    } else {
                        const userCredential = await signInWithEmailAndPassword(auth, email, password);
                        currentUser = userCredential.user;
                        currentUserId = userCredential.user.uid;
                        renderPage('dashboard');
                    }
                } catch (error) {
                    console.error("Auth Fehler:", error);
                    let msg = "Ein unbekannter Fehler ist aufgetreten.";
                    if (error.code === 'auth/invalid-email') {
                        msg = "Ungültige E-Mail-Adresse.";
                    } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        msg = "E-Mail oder Passwort ist falsch.";
                    } else if (error.code === 'auth/email-already-in-use') {
                        msg = "Diese E-Mail-Adresse wird bereits verwendet.";
                    } else if (error.code === 'auth/weak-password') {
                        msg = "Das Passwort ist zu schwach (mind. 6 Zeichen).";
                    }
                    errorMessage = msg;
                } finally {
                    loading = false;
                    updateUI(); // UI final aktualisieren
                }
            };

            updateUI(); // Initialer Render
        }

        // --- Dashboard-Seite ---
        async function renderDashboardPage() {
            let transactions = [];
            let newAmount = '';
            let newDescription = '';
            let newType = 'expense';
            let newCategoryId = currentCategories.length > 0 ? currentCategories[0].id : '';
            let errorMessage = '';
            let loading = false;
            let showResetConfirmation = false;

            const categoriesCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/categories`);
            const transactionsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/transactions`);
            const recurringTransactionsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/recurringTransactions`);

            const updateDashboardUI = () => {
                const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const balance = totalIncome - totalExpense;

                mainContent.innerHTML = `
                    <div class="${getCardClasses()} max-w-3xl mx-auto">
                        <h2 class="${getTitleClasses()}">Dein Budget-Dashboard</h2>

                        ${errorMessage ? `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md relative mb-4" role="alert">
                            <strong class="font-bold">Fehler!</strong>
                            <span class="block sm:inline"> ${errorMessage}</span>
                        </div>` : ''}

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 text-center">
                            <div class="p-4 rounded-lg shadow-sm ${darkMode ? `bg-[${colors.darkGreen}] text-[${colors.darkText}]` : `bg-[${colors.lightBeige}] text-[${colors.darkBlueGreen}]`}">
                                <p class="text-lg">Einnahmen</p>
                                <p class="text-2xl font-bold">${totalIncome.toFixed(2)} CHF</p>
                            </div>
                            <div class="p-4 rounded-lg shadow-sm ${darkMode ? `bg-red-800 text-white` : 'bg-red-100 text-red-800'}">
                                <p class="text-lg">Ausgaben</p>
                                <p class="text-2xl font-bold">${totalExpense.toFixed(2)} CHF</p>
                            </div>
                            <div class="p-4 rounded-lg shadow-sm ${balance >= 0
                                ? (darkMode ? `bg-[${colors.darkGreen}] text-[${colors.darkText}]` : `bg-[${colors.lightBeige}] text-[${colors.darkGreen}]`)
                                : (darkMode ? `bg-yellow-800 text-white` : 'bg-yellow-100 text-yellow-600')
                            }">
                                <p class="text-lg">Saldo</p>
                                <p class="text-2xl font-bold">${balance.toFixed(2)} CHF</p>
                            </div>
                        </div>

                        <div class="${getInnerCardClasses()}">
                            <h3 class="${getSubtitleClasses()}">Neue Transaktion hinzufügen</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="${getLabelClasses()}" for="amount">Betrag (CHF)</label>
                                    <input type="number" id="amount" class="${getInputClasses()}" placeholder="z.B. 50.00" value="${newAmount}" ${loading ? 'disabled' : ''}>
                                </div>
                                <div>
                                    <label class="${getLabelClasses()}" for="description">Beschreibung</label>
                                    <input type="text" id="description" class="${getInputClasses()}" placeholder="z.B. Lohn Juli" value="${newDescription}" ${loading ? 'disabled' : ''}>
                                </div>
                                <div>
                                    <label class="${getLabelClasses()}" for="type">Typ</label>
                                    <select id="type" class="${getInputClasses()}" ${loading ? 'disabled' : ''}>
                                        <option value="expense" ${newType === 'expense' ? 'selected' : ''}>Ausgabe</option>
                                        <option value="income" ${newType === 'income' ? 'selected' : ''}>Einnahme</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="${getLabelClasses()}" for="category">Kategorie</label>
                                    <select id="category" class="${getInputClasses()}" ${loading || currentCategories.length === 0 ? 'disabled' : ''}>
                                        ${currentCategories.length === 0 ? `<option value="">Keine Kategorien verfügbar</option>` :
                                            currentCategories.map(cat => `<option value="${cat.id}" ${newCategoryId === cat.id ? 'selected' : ''}>${cat.name}</option>`).join('')
                                        }
                                    </select>
                                </div>
                            </div>
                            <button id="add-transaction-btn" class="w-full ${getButtonClasses(darkMode ? colors.darkGreen : colors.darkBlueGreen, darkMode ? colors.darkBlueGreen : colors.darkGreen)}" ${loading || currentCategories.length === 0 ? 'disabled' : ''}>
                                ${loading ? 'Hinzufügen...' : 'Transaktion hinzufügen'}
                            </button>
                            ${currentCategories.length === 0 ? `<p class="text-sm text-red-500 mt-2 text-center">Bitte füge zuerst Kategorien im Reiter "Kategorien" hinzu, um Transaktionen zu erfassen.</p>` : ''}
                        </div>

                        <div class="${getInnerCardClasses()}">
                            <h3 class="${getSubtitleClasses()}">Letzte Transaktionen</h3>
                            ${transactions.length === 0 ? `<p class="${getItalicTextClasses()}">Noch keine Transaktionen vorhanden.</p>` : `
                                <ul class="space-y-3">
                                    ${transactions.map(t => `
                                        <li class="${getListItemClasses()}">
                                            <div>
                                                <span class="${t.type === 'income' ? getIncomeTextClasses() : getExpenseTextClasses()}">
                                                    ${t.type === 'income' ? '+' : '-'} ${t.amount.toFixed(2)} CHF
                                                </span>
                                                <p class="${getSmallTextClasses()}">${t.description}</p>
                                                <p class="${getXSmallTextClasses()}">
                                                    Kategorie: ${currentCategories.find(cat => cat.id === t.categoryId)?.name || 'Unbekannt'}
                                                    ${t.createdAt && t.createdAt.toDate ? ` | ${new Date(t.createdAt.toDate()).toLocaleDateString()}` : ''}
                                                </p>
                                            </div>
                                        </li>
                                    `).join('')}
                                </ul>
                            `}
                        </div>

                        <div class="mt-6 sm:mt-8 text-center">
                            <button id="reset-dashboard-btn" class="${getButtonClasses(darkMode ? colors.mediumGreen : colors.mediumGreen, darkMode ? colors.darkGreen : colors.darkGreen)}" ${loading ? 'disabled' : ''}>
                                Dashboard zurücksetzen
                            </button>
                        </div>
                    </div>

                    ${showResetConfirmation ? `
                        <div class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 p-4">
                            <div class="${getCardClasses()} max-w-sm sm:max-w-md w-full text-center">
                                <h3 class="${getSubtitleClasses()} text-xl sm:text-2xl">Dashboard zurücksetzen?</h3>
                                <p class="mb-5 sm:mb-6 text-sm sm:text-base ${darkMode ? `text-gray-300` : `text-gray-700`}">
                                    Bist du sicher, dass du alle deine Transaktionen löschen möchtest? Diese Aktion kann nicht rückgängig gemacht werden.
                                </p>
                                <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                                    <button id="confirm-reset-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 sm:py-2.5 sm:px-5 rounded-lg text-sm sm:text-base transition-all duration-200" ${loading ? 'disabled' : ''}>
                                        Ja, löschen
                                    </button>
                                    <button id="cancel-reset-btn" class="${getButtonClasses(darkMode ? 'gray-700' : colors.lightGrayBlue, darkMode ? 'gray-600' : 'gray-300')} text-sm sm:text-base" ${loading ? 'disabled' : ''}>
                                        Abbrechen
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                `;

                // Event Listener neu zuweisen
                const amountInput = document.getElementById('amount');
                if (amountInput) amountInput.oninput = (e) => { newAmount = e.target.value; };
                const descriptionInput = document.getElementById('description');
                if (descriptionInput) descriptionInput.oninput = (e) => { newDescription = e.target.value; };
                const typeSelect = document.getElementById('type');
                if (typeSelect) typeSelect.onchange = (e) => { newType = e.target.value; };
                const categorySelect = document.getElementById('category');
                if (categorySelect) categorySelect.onchange = (e) => { newCategoryId = e.target.value; };

                const addTransactionBtn = document.getElementById('add-transaction-btn');
                if (addTransactionBtn) addTransactionBtn.onclick = handleAddTransaction;

                const resetDashboardBtn = document.getElementById('reset-dashboard-btn');
                if (resetDashboardBtn) resetDashboardBtn.onclick = () => { showResetConfirmation = true; updateDashboardUI(); };

                const confirmResetBtn = document.getElementById('confirm-reset-btn');
                if (confirmResetBtn) confirmResetBtn.onclick = confirmResetDashboard;

                const cancelResetBtn = document.getElementById('cancel-reset-btn');
                if (cancelResetBtn) cancelResetBtn.onclick = () => { showResetConfirmation = false; updateDashboardUI(); };
            };

            const handleAddTransaction = async () => {
                errorMessage = '';
                if (newAmount === '' || isNaN(parseFloat(newAmount)) || parseFloat(newAmount) <= 0) {
                    errorMessage = "Bitte einen gültigen Betrag eingeben.";
                    updateDashboardUI(); return;
                }
                if (newDescription.trim() === '') {
                    errorMessage = "Bitte eine Beschreibung eingeben.";
                    updateDashboardUI(); return;
                }
                if (newCategoryId === '' && currentCategories.length > 0) {
                    errorMessage = "Bitte eine Kategorie auswählen.";
                    updateDashboardUI(); return;
                }

                loading = true;
                updateDashboardUI();
                try {
                    await addDoc(transactionsCollectionRef, {
                        amount: parseFloat(newAmount),
                        description: newDescription.trim(),
                        type: newType,
                        categoryId: newCategoryId,
                        createdAt: serverTimestamp(),
                        userId: currentUserId
                    });
                    newAmount = '';
                    newDescription = '';
                } catch (error) {
                    console.error("Fehler beim Hinzufügen der Transaktion:", error);
                    errorMessage = "Fehler beim Hinzufügen der Transaktion.";
                } finally {
                    loading = false;
                    updateDashboardUI();
                }
            };

            const confirmResetDashboard = async () => {
                loading = true;
                errorMessage = '';
                showResetConfirmation = false;
                updateDashboardUI();

                try {
                    const q = query(transactionsCollectionRef);
                    const querySnapshot = await getDocs(q);
                    const batch = writeBatch(db);

                    querySnapshot.docs.forEach((document) => {
                        batch.delete(document.ref);
                    });

                    await batch.commit();
                    console.log("Dashboard erfolgreich zurückgesetzt (alle Transaktionen gelöscht).");
                } catch (error) {
                    console.error("Fehler beim Zurücksetzen des Dashboards:", error);
                    errorMessage = "Fehler beim Zurücksetzen des Dashboards: " + error.message;
                } finally {
                    loading = false;
                    updateDashboardUI();
                }
            };

            // Listener für Transaktionen
            onSnapshot(query(transactionsCollectionRef, orderBy('createdAt', 'desc')), (snapshot) => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateDashboardUI();
            }, (error) => {
                console.error("Fehler beim Abrufen der Transaktionen:", error);
                errorMessage = "Fehler beim Laden der Transaktionen.";
                updateDashboardUI();
            });

            // Listener für Kategorien (falls noch nicht global geladen)
            onSnapshot(query(categoriesCollectionRef), (snapshot) => {
                currentCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (newCategoryId === '' && currentCategories.length > 0) {
                    newCategoryId = currentCategories[0].id;
                }
                updateDashboardUI();
            }, (error) => {
                console.error("Fehler beim Abrufen der Kategorien:", error);
                errorMessage = "Fehler beim Laden der Kategorien.";
                updateDashboardUI();
            });

            // Automatische Hinzufügung wiederkehrender Transaktionen
            const addRecurringTransactions = async () => {
                try {
                    const q = query(recurringTransactionsCollectionRef);
                    const querySnapshot = await getDocs(q);
                    const batch = writeBatch(db);
                    const today = new Date();
                    const currentMonth = today.getMonth();
                    const currentYear = today.getFullYear();
                    const currentDay = today.getDate();

                    for (const docSnapshot of querySnapshot.docs) {
                        const recurring = docSnapshot.data();
                        const recurringId = docSnapshot.id;

                        let lastAppliedMonth = -1;
                        let lastAppliedYear = -1;

                        if (recurring.lastAppliedDate && recurring.lastAppliedDate.toDate) {
                            const lastDate = recurring.lastAppliedDate.toDate();
                            lastAppliedMonth = lastDate.getMonth();
                            lastAppliedYear = lastDate.getFullYear();
                        }

                        let shouldAdd = false;

                        if (recurring.frequency === 'monthly') {
                            if (recurring.recurringDay && currentDay >= recurring.recurringDay) {
                                if (lastAppliedYear < currentYear || (lastAppliedYear === currentYear && lastAppliedMonth < currentMonth)) {
                                    shouldAdd = true;
                                }
                            } else if (!recurring.recurringDay) {
                                 if (lastAppliedYear < currentYear || (lastAppliedYear === currentYear && lastAppliedMonth < currentMonth)) {
                                    shouldAdd = true;
                                 }
                            }
                        } else if (recurring.frequency === 'weekly') {
                            const oneWeek = 7 * 24 * 60 * 60 * 1000;
                            const lastAppliedTime = recurring.lastAppliedDate ? recurring.lastAppliedDate.toDate().getTime() : 0;
                            if (today.getTime() - lastAppliedTime > oneWeek) {
                                shouldAdd = true;
                            }
                        } else if (recurring.frequency === 'yearly') {
                            if (lastAppliedYear < currentYear) {
                                shouldAdd = true;
                            }
                        }

                        if (shouldAdd) {
                            const newTransactionRef = doc(transactionsCollectionRef);
                            batch.set(newTransactionRef, {
                                amount: recurring.amount,
                                description: `(Wiederkehrend) ${recurring.name}`,
                                type: recurring.type,
                                categoryId: recurring.categoryId,
                                createdAt: serverTimestamp(),
                                userId: currentUserId,
                                recurringSourceId: recurringId,
                            });

                            batch.update(doc(recurringTransactionsCollectionRef, recurringId), {
                                lastAppliedDate: serverTimestamp(),
                            });
                        }
                    }
                    await batch.commit();
                    console.log("Wiederkehrende Transaktionen erfolgreich angewendet.");
                } catch (error) {
                    console.error("Fehler beim automatischen Hinzufügen wiederkehrender Transaktionen:", error);
                }
            };

            addRecurringTransactions(); // Beim Laden des Dashboards ausführen
            updateDashboardUI(); // Initialer Render
        }

        // --- Kategorien-Seite ---
        async function renderCategoriesPage() {
            let categories = [];
            let newCategoryName = '';
            let errorMessage = '';
            let loading = false;

            const categoriesCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/categories`);

            const updateCategoriesUI = () => {
                mainContent.innerHTML = `
                    <div class="${getCardClasses()} max-w-2xl mx-auto">
                        <h2 class="${getTitleClasses()}">Kategorien verwalten</h2>

                        ${errorMessage ? `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md relative mb-4" role="alert">
                            <strong class="font-bold">Fehler!</strong>
                            <span class="block sm:inline"> ${errorMessage}</span>
                        </div>` : ''}

                        <div class="${getInnerCardClasses()}">
                            <h3 class="${getSubtitleClasses()}">Neue Kategorie hinzufügen</h3>
                            <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
                                <input type="text" id="new-category-name" class="flex-grow ${getInputClasses()}" placeholder="Name der neuen Kategorie" value="${newCategoryName}" ${loading ? 'disabled' : ''}>
                                <button id="add-category-btn" class="${getButtonClasses(darkMode ? colors.darkGreen : colors.darkGreen, darkMode ? colors.darkBlueGreen : colors.darkBlueGreen)}" ${loading ? 'disabled' : ''}>
                                    ${loading ? 'Hinzufügen...' : 'Hinzufügen'}
                                </button>
                            </div>
                        </div>

                        <div class="${getInnerCardClasses()}">
                            <h3 class="${getSubtitleClasses()}">Deine Kategorien</h3>
                            ${categories.length === 0 ? `<p class="${getItalicTextClasses()}">Noch keine Kategorien vorhanden. Füge eine hinzu!</p>` : `
                                <ul class="space-y-3">
                                    ${categories.map(cat => `
                                        <li class="${getListItemClasses()}">
                                            <span class="text-lg font-medium">${cat.name}</span>
                                            <button data-id="${cat.id}" class="delete-category-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm focus:outline-none focus:shadow-outline transition-all duration-200 transform hover:scale-105" ${loading ? 'disabled' : ''}>
                                                ${loading ? 'Lösche...' : 'Löschen'}
                                            </button>
                                        </li>
                                    `).join('')}
                                </ul>
                            `}
                        </div>
                    </div>
                `;

                // Event Listener neu zuweisen
                const newCategoryNameInput = document.getElementById('new-category-name');
                if (newCategoryNameInput) newCategoryNameInput.oninput = (e) => { newCategoryName = e.target.value; };

                const addCategoryBtn = document.getElementById('add-category-btn');
                if (addCategoryBtn) addCategoryBtn.onclick = handleAddCategory;

                document.querySelectorAll('.delete-category-btn').forEach(button => {
                    button.onclick = (e) => handleDeleteCategory(e.target.dataset.id);
                });
            };

            const handleAddCategory = async () => {
                if (newCategoryName.trim() === '') {
                    errorMessage = "Der Kategoriename darf nicht leer sein.";
                    updateCategoriesUI(); return;
                }
                loading = true;
                errorMessage = '';
                updateCategoriesUI();
                try {
                    await addDoc(categoriesCollectionRef, {
                        name: newCategoryName.trim(),
                        createdAt: new Date(),
                        userId: currentUserId
                    });
                    newCategoryName = '';
                } catch (error) {
                    console.error("Fehler beim Hinzufügen der Kategorie:", error);
                    errorMessage = "Fehler beim Hinzufügen der Kategorie.";
                } finally {
                    loading = false;
                    updateCategoriesUI();
                }
            };

            const handleDeleteCategory = async (categoryId) => {
                loading = true;
                errorMessage = '';
                updateCategoriesUI();
                try {
                    const categoryDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/categories`, categoryId);
                    await deleteDoc(categoryDocRef);
                } catch (error) {
                    console.error("Fehler beim Löschen der Kategorie:", error);
                    errorMessage = "Fehler beim Löschen der Kategorie.";
                } finally {
                    loading = false;
                    updateCategoriesUI();
                }
            };

            onSnapshot(query(categoriesCollectionRef), (snapshot) => {
                categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                currentCategories = categories; // Globalen Cache aktualisieren
                updateCategoriesUI();
            }, (error) => {
                console.error("Fehler beim Abrufen der Kategorien:", error);
                errorMessage = "Fehler beim Laden der Kategorien.";
                updateCategoriesUI();
            });

            updateCategoriesUI(); // Initialer Render
        }

        // --- Einstellungen-Seite (Wiederkehrende Transaktionen) ---
        async function renderSettingsPage() {
            let recurringTransactions = [];
            let newRecurringName = '';
            let newRecurringAmount = '';
            let newRecurringType = 'expense';
            let newRecurringCategoryId = currentCategories.length > 0 ? currentCategories[0].id : '';
            let newRecurringDay = '';
            let newFrequency = 'monthly';
            let errorMessage = '';
            let loading = false;

            const recurringTransactionsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/recurringTransactions`);

            const updateSettingsUI = () => {
                mainContent.innerHTML = `
                    <div class="${getCardClasses()} max-w-3xl mx-auto">
                        <h2 class="${getTitleClasses()}">Einstellungen für wiederkehrende Transaktionen</h2>

                        ${errorMessage ? `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md relative mb-4" role="alert">
                            <strong class="font-bold">Fehler!</strong>
                            <span class="block sm:inline"> ${errorMessage}</span>
                        </div>` : ''}

                        <div class="${getInnerCardClasses()}">
                            <h3 class="${getSubtitleClasses()}">Neue wiederkehrende Transaktion hinzufügen</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="${getLabelClasses()}" for="recurringName">Name</label>
                                    <input type="text" id="recurringName" class="${getInputClasses()}" placeholder="z.B. Handy Abo" value="${newRecurringName}" ${loading ? 'disabled' : ''}>
                                </div>
                                <div>
                                    <label class="${getLabelClasses()}" for="recurringAmount">Betrag (CHF)</label>
                                    <input type="number" id="recurringAmount" class="${getInputClasses()}" placeholder="z.B. 49.90" value="${newRecurringAmount}" ${loading ? 'disabled' : ''}>
                                </div>
                                <div>
                                    <label class="${getLabelClasses()}" for="recurringType">Typ</label>
                                    <select id="recurringType" class="${getInputClasses()}" ${loading ? 'disabled' : ''}>
                                        <option value="expense" ${newRecurringType === 'expense' ? 'selected' : ''}>Ausgabe</option>
                                        <option value="income" ${newRecurringType === 'income' ? 'selected' : ''}>Einnahme</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="${getLabelClasses()}" for="recurringCategory">Kategorie</label>
                                    <select id="recurringCategory" class="${getInputClasses()}" ${loading || currentCategories.length === 0 ? 'disabled' : ''}>
                                        ${currentCategories.length === 0 ? `<option value="">Keine Kategorien verfügbar</option>` :
                                            currentCategories.map(cat => `<option value="${cat.id}" ${newRecurringCategoryId === cat.id ? 'selected' : ''}>${cat.name}</option>`).join('')
                                        }
                                    </select>
                                </div>
                                <div>
                                    <label class="${getLabelClasses()}" for="frequency">Häufigkeit</label>
                                    <select id="frequency" class="${getInputClasses()}" ${loading ? 'disabled' : ''}>
                                        <option value="monthly" ${newFrequency === 'monthly' ? 'selected' : ''}>Monatlich</option>
                                        <option value="weekly" ${newFrequency === 'weekly' ? 'selected' : ''}>Wöchentlich</option>
                                        <option value="yearly" ${newFrequency === 'yearly' ? 'selected' : ''}>Jährlich</option>
                                    </select>
                                </div>
                                ${newRecurringType === 'income' && newFrequency === 'monthly' ? `
                                    <div>
                                        <label class="${getLabelClasses()}" for="recurringDay">Monatlicher Zahltag (Tag des Monats)</label>
                                        <input type="number" id="recurringDay" class="${getInputClasses()}" placeholder="z.B. 25" min="1" max="31" value="${newRecurringDay}" ${loading ? 'disabled' : ''}>
                                    </div>
                                ` : ''}
                            </div>
                            <button id="add-recurring-btn" class="w-full ${getButtonClasses(darkMode ? colors.darkGreen : colors.darkGreen, darkMode ? colors.darkBlueGreen : colors.darkBlueGreen)}" ${loading || (currentCategories.length === 0 && newRecurringType !== 'income') ? 'disabled' : ''}>
                                ${loading ? 'Hinzufügen...' : 'Wiederkehrende Transaktion hinzufügen'}
                            </button>
                            ${currentCategories.length === 0 ? `<p class="text-sm text-red-500 mt-2 text-center">Bitte füge zuerst Kategorien im Reiter "Kategorien" hinzu, um wiederkehrende Transaktionen zu erfassen.</p>` : ''}
                        </div>

                        <div class="${getInnerCardClasses()}">
                            <h3 class="${getSubtitleClasses()}">Deine wiederkehrenden Transaktionen</h3>
                            ${recurringTransactions.length === 0 ? `<p class="${getItalicTextClasses()}">Noch keine wiederkehrenden Transaktionen vorhanden.</p>` : `
                                <ul class="space-y-3">
                                    ${recurringTransactions.map(t => `
                                        <li class="${getListItemClasses()}">
                                            <div>
                                                <span class="${t.type === 'income' ? getIncomeTextClasses() : getExpenseTextClasses()}">
                                                    ${t.name}: ${t.type === 'income' ? '+' : '-'} ${t.amount.toFixed(2)} CHF
                                                </span>
                                                <p class="${getXSmallTextClasses()}">
                                                    Kategorie: ${currentCategories.find(cat => cat.id === t.categoryId)?.name || 'Unbekannt'} | Häufigkeit: ${
                                                        t.frequency === 'monthly' ? 'Monatlich' :
                                                        t.frequency === 'weekly' ? 'Wöchentlich' :
                                                        t.frequency === 'yearly' ? 'Jährlich' : 'Unbekannt'
                                                    }
                                                    ${t.recurringDay ? ` | Zahltag: Tag ${t.recurringDay} des Monats` : ''}
                                                </p>
                                            </div>
                                            <button data-id="${t.id}" class="delete-recurring-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm focus:outline-none focus:shadow-outline transition-all duration-200 transform hover:scale-105" ${loading ? 'disabled' : ''}>
                                                ${loading ? 'Lösche...' : 'Löschen'}
                                            </button>
                                        </li>
                                    `).join('')}
                                </ul>
                            `}
                        </div>
                    </div>
                `;

                // Event Listener neu zuweisen
                const recurringNameInput = document.getElementById('recurringName');
                if (recurringNameInput) recurringNameInput.oninput = (e) => { newRecurringName = e.target.value; };
                const recurringAmountInput = document.getElementById('recurringAmount');
                if (recurringAmountInput) recurringAmountInput.oninput = (e) => { newRecurringAmount = e.target.value; };
                const recurringTypeSelect = document.getElementById('recurringType');
                if (recurringTypeSelect) recurringTypeSelect.onchange = (e) => {
                    newRecurringType = e.target.value;
                    updateSettingsUI(); // UI neu rendern, um Datumsfeld anzuzeigen/verbergen
                };
                const recurringCategorySelect = document.getElementById('recurringCategory');
                if (recurringCategorySelect) recurringCategorySelect.onchange = (e) => { newRecurringCategoryId = e.target.value; };
                const frequencySelect = document.getElementById('frequency');
                if (frequencySelect) frequencySelect.onchange = (e) => {
                    newFrequency = e.target.value;
                    updateSettingsUI(); // UI neu rendern, um Datumsfeld anzuzeigen/verbergen
                };
                const recurringDayInput = document.getElementById('recurringDay');
                if (recurringDayInput) recurringDayInput.oninput = (e) => { newRecurringDay = e.target.value; };

                const addRecurringBtn = document.getElementById('add-recurring-btn');
                if (addRecurringBtn) addRecurringBtn.onclick = handleAddRecurringTransaction;

                document.querySelectorAll('.delete-recurring-btn').forEach(button => {
                    button.onclick = (e) => handleDeleteRecurringTransaction(e.target.dataset.id);
                });
            };

            const handleAddRecurringTransaction = async () => {
                errorMessage = '';
                if (newRecurringName.trim() === '') {
                    errorMessage = "Bitte einen Namen für die wiederkehrende Transaktion eingeben.";
                    updateSettingsUI(); return;
                }
                if (newRecurringAmount === '' || isNaN(parseFloat(newRecurringAmount)) || parseFloat(newRecurringAmount) <= 0) {
                    errorMessage = "Bitte einen gültigen Betrag eingeben.";
                    updateSettingsUI(); return;
                }
                if (newRecurringCategoryId === '' && currentCategories.length === 0) {
                    errorMessage = "Bitte füge zuerst Kategorien hinzu, bevor du Transaktionen erfasst.";
                    updateSettingsUI(); return;
                }
                const day = parseInt(newRecurringDay, 10);
                if (newRecurringType === 'income' && newFrequency === 'monthly' && (isNaN(day) || day < 1 || day > 31)) {
                    errorMessage = "Bitte einen gültigen Tag (1-31) für monatliche wiederkehrende Einnahmen angeben.";
                    updateSettingsUI(); return;
                }

                loading = true;
                updateSettingsUI();
                try {
                    await addDoc(recurringTransactionsCollectionRef, {
                        name: newRecurringName.trim(),
                        amount: parseFloat(newRecurringAmount),
                        type: newRecurringType,
                        categoryId: newRecurringCategoryId,
                        frequency: newFrequency,
                        recurringDay: newRecurringType === 'income' && newFrequency === 'monthly' ? day : null,
                        createdAt: serverTimestamp(),
                        userId: currentUserId
                    });
                    newRecurringName = '';
                    newRecurringAmount = '';
                    newRecurringDay = '';
                } catch (error) {
                    console.error("Fehler beim Hinzufügen der wiederkehrenden Transaktion:", error);
                    errorMessage = "Fehler beim Hinzufügen der wiederkehrenden Transaktion.";
                } finally {
                    loading = false;
                    updateSettingsUI();
                }
            };

            const handleDeleteRecurringTransaction = async (transactionId) => {
                loading = true;
                errorMessage = '';
                updateSettingsUI();
                try {
                    const transactionDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/recurringTransactions`, transactionId);
                    await deleteDoc(transactionDocRef);
                } catch (error) {
                    console.error("Fehler beim Löschen der wiederkehrenden Transaktion:", error);
                    errorMessage = "Fehler beim Löschen der wiederkehrenden Transaktion.";
                } finally {
                    loading = false;
                    updateSettingsUI();
                }
            };

            onSnapshot(query(recurringTransactionsCollectionRef, orderBy('createdAt', 'desc')), (snapshot) => {
                recurringTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateSettingsUI();
            }, (error) => {
                console.error("Fehler beim Abrufen der wiederkehrenden Transaktionen:", error);
                errorMessage = "Fehler beim Laden der wiederkehrenden Transaktionen.";
                updateSettingsUI();
            });

            // Kategorien Listener (um currentCategories aktuell zu halten)
            onSnapshot(query(collection(db, `artifacts/${appId}/users/${currentUserId}/categories`)), (snapshot) => {
                currentCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (newRecurringCategoryId === '' && currentCategories.length > 0) {
                    newRecurringCategoryId = currentCategories[0].id;
                }
                updateSettingsUI();
            }, (error) => {
                console.error("Fehler beim Abrufen der Kategorien für Einstellungen:", error);
                errorMessage = "Fehler beim Laden der Kategorien.";
                updateSettingsUI();
            });

            updateSettingsUI(); // Initialer Render
        }

        // --- Budgetgrenzen-Seite ---
        async function renderBudgetLimitsPage() {
            let budgetLimits = [];
            let newLimitAmount = '';
            let selectedCategoryId = currentCategories.length > 0 ? currentCategories[0].id : '';
            let errorMessage = '';
            let loading = false;

            const budgetLimitsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/budgetLimits`);

            const updateBudgetLimitsUI = () => {
                mainContent.innerHTML = `
                    <div class="${getCardClasses()} max-w-3xl mx-auto">
                        <h2 class="${getTitleClasses()}">Budgetgrenzen verwalten</h2>

                        ${errorMessage ? `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md relative mb-4" role="alert">
                            <strong class="font-bold">Fehler!</strong>
                            <span class="block sm:inline"> ${errorMessage}</span>
                        </div>` : ''}

                        <div class="${getInnerCardClasses()}">
                            <h3 class="${getSubtitleClasses()}">Budgetgrenze festlegen</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="${getLabelClasses()}" for="limitCategory">Kategorie</label>
                                    <select id="limitCategory" class="${getInputClasses()}" ${loading || currentCategories.length === 0 ? 'disabled' : ''}>
                                        ${currentCategories.length === 0 ? `<option value="">Keine Kategorien verfügbar</option>` : `
                                            <option value="">Kategorie auswählen</option>
                                            ${currentCategories.map(cat => `<option value="${cat.id}" ${selectedCategoryId === cat.id ? 'selected' : ''}>${cat.name}</option>`).join('')}
                                        `}
                                    </select>
                                </div>
                                <div>
                                    <label class="${getLabelClasses()}" for="limitAmount">Grenze (CHF)</label>
                                    <input type="number" id="limitAmount" class="${getInputClasses()}" placeholder="z.B. 200.00" value="${newLimitAmount}" ${loading ? 'disabled' : ''}>
                                </div>
                            </div>
                            <button id="set-limit-btn" class="w-full ${getButtonClasses(darkMode ? colors.darkGreen : colors.darkGreen, darkMode ? colors.darkBlueGreen : colors.darkBlueGreen)}" ${loading || currentCategories.length === 0 || selectedCategoryId === '' ? 'disabled' : ''}>
                                ${loading ? 'Speichere...' : 'Grenze festlegen'}
                            </button>
                            ${currentCategories.length === 0 ? `<p class="text-sm text-red-500 mt-2 text-center">Bitte füge zuerst Kategorien im Reiter "Kategorien" hinzu, um Budgetgrenzen festzulegen.</p>` : ''}
                        </div>

                        <div class="${getInnerCardClasses()}">
                            <h3 class="${getSubtitleClasses()}">Deine Budgetgrenzen</h3>
                            ${budgetLimits.length === 0 ? `<p class="${getItalicTextClasses()}">Noch keine Budgetgrenzen festgelegt.</p>` : `
                                <ul class="space-y-3">
                                    ${budgetLimits.map(limit => `
                                        <li class="${getListItemClasses()}">
                                            <div>
                                                <span class="text-lg font-medium">${currentCategories.find(cat => cat.id === limit.categoryId)?.name || 'Unbekannt'}</span>
                                                <p class="${getSmallTextClasses()}">Grenze: ${limit.amount.toFixed(2)} CHF</p>
                                            </div>
                                            <button data-id="${limit.id}" class="delete-limit-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm focus:outline-none focus:shadow-outline transition-all duration-200 transform hover:scale-105" ${loading ? 'disabled' : ''}>
                                                ${loading ? 'Lösche...' : 'Löschen'}
                                            </button>
                                        </li>
                                    `).join('')}
                                </ul>
                            `}
                        </div>
                    </div>
                `;

                // Event Listener neu zuweisen
                const limitCategorySelect = document.getElementById('limitCategory');
                if (limitCategorySelect) limitCategorySelect.onchange = (e) => { selectedCategoryId = e.target.value; };
                const limitAmountInput = document.getElementById('limitAmount');
                if (limitAmountInput) limitAmountInput.oninput = (e) => { newLimitAmount = e.target.value; };

                const setLimitBtn = document.getElementById('set-limit-btn');
                if (setLimitBtn) setLimitBtn.onclick = handleSetBudgetLimit;

                document.querySelectorAll('.delete-limit-btn').forEach(button => {
                    button.onclick = (e) => handleDeleteBudgetLimit(e.target.dataset.id);
                });
            };

            const handleSetBudgetLimit = async () => {
                errorMessage = '';
                if (selectedCategoryId === '') {
                    errorMessage = "Bitte eine Kategorie auswählen.";
                    updateBudgetLimitsUI(); return;
                }
                if (newLimitAmount === '' || isNaN(parseFloat(newLimitAmount)) || parseFloat(newLimitAmount) <= 0) {
                    errorMessage = "Bitte einen gültigen Betrag für die Grenze eingeben.";
                    updateBudgetLimitsUI(); return;
                }

                loading = true;
                updateBudgetLimitsUI();
                try {
                    const existingLimit = budgetLimits.find(limit => limit.categoryId === selectedCategoryId);
                    const limitRef = existingLimit
                        ? doc(db, `artifacts/${appId}/users/${currentUserId}/budgetLimits`, existingLimit.id)
                        : doc(budgetLimitsCollectionRef);

                    await setDoc(limitRef, {
                        categoryId: selectedCategoryId,
                        amount: parseFloat(newLimitAmount),
                        userId: currentUserId,
                        updatedAt: serverTimestamp(),
                    }, { merge: true });

                    newLimitAmount = '';
                } catch (error) {
                    console.error("Fehler beim Setzen der Budgetgrenze:", error);
                    errorMessage = "Fehler beim Setzen der Budgetgrenze.";
                } finally {
                    loading = false;
                    updateBudgetLimitsUI();
                }
            };

            const handleDeleteBudgetLimit = async (limitId) => {
                loading = true;
                errorMessage = '';
                updateBudgetLimitsUI();
                try {
                    const limitDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/budgetLimits`, limitId);
                    await deleteDoc(limitDocRef);
                } catch (error) {
                    console.error("Fehler beim Löschen der Budgetgrenze:", error);
                    errorMessage = "Fehler beim Löschen der Budgetgrenze.";
                } finally {
                    loading = false;
                    updateBudgetLimitsUI();
                }
            };

            onSnapshot(query(budgetLimitsCollectionRef), (snapshot) => {
                budgetLimits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateBudgetLimitsUI();
            }, (error) => {
                console.error("Fehler beim Abrufen der Budgetgrenzen:", error);
                errorMessage = "Fehler beim Laden der Budgetgrenzen.";
                updateBudgetLimitsUI();
            });

            // Kategorien Listener (um currentCategories aktuell zu halten)
            onSnapshot(query(collection(db, `artifacts/${appId}/users/${currentUserId}/categories`)), (snapshot) => {
                currentCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (selectedCategoryId === '' && currentCategories.length > 0) {
                    selectedCategoryId = currentCategories[0].id;
                }
                updateBudgetLimitsUI();
            }, (error) => {
                console.error("Fehler beim Abrufen der Kategorien für Budgetgrenzen:", error);
                errorMessage = "Fehler beim Laden der Kategorien.";
                updateBudgetLimitsUI();
            });

            updateBudgetLimitsUI(); // Initialer Render
        }

        // --- Rechnungen hochladen Seite ---
        function renderInvoiceUploadPage() {
            let selectedFile = null;
            let imagePreviewUrl = '';
            let errorMessage = '';
            let loading = false;
            let recognizedData = null; // { amount, description, type, date, categoryId }
            let reviewMode = false; // true, wenn Daten zur Überprüfung angezeigt werden

            const updateInvoiceUploadUI = () => {
                mainContent.innerHTML = `
                    <div class="${getCardClasses()} max-w-3xl mx-auto">
                        <h2 class="${getTitleClasses()}">Rechnungen hochladen & erkennen</h2>

                        ${errorMessage ? `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md relative mb-4" role="alert">
                            <strong class="font-bold">Fehler!</strong>
                            <span class="block sm:inline"> ${errorMessage}</span>
                        </div>` : ''}

                        <div class="${getInnerCardClasses()}">
                            <h3 class="${getSubtitleClasses()}">Rechnung hochladen</h3>
                            <input type="file" id="invoice-file-input" accept="image/*" class="${getInputClasses()} mb-4" ${loading ? 'disabled' : ''}>
                            ${imagePreviewUrl ? `<div class="mb-4 text-center"><img src="${imagePreviewUrl}" alt="Rechnungsvorschau" class="max-w-full h-auto rounded-lg shadow-md mx-auto"></div>` : ''}
                            <button id="analyze-invoice-btn" class="w-full ${getButtonClasses(darkMode ? colors.darkGreen : colors.darkBlueGreen, darkMode ? colors.darkBlueGreen : colors.darkGreen)}" ${!selectedFile || loading || reviewMode ? 'disabled' : ''}>
                                ${loading ? 'Analysiere...' : 'Rechnung analysieren'}
                            </button>
                        </div>

                        ${reviewMode ? `
                            <div class="${getInnerCardClasses()} mt-8">
                                <h3 class="${getSubtitleClasses()}">Erkannte Daten überprüfen</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="${getLabelClasses()}" for="recognizedAmount">Betrag (CHF)</label>
                                        <input type="number" id="recognizedAmount" class="${getInputClasses()}" value="${recognizedData.amount || ''}" ${loading ? 'disabled' : ''}>
                                    </div>
                                    <div>
                                        <label class="${getLabelClasses()}" for="recognizedDescription">Beschreibung</label>
                                        <input type="text" id="recognizedDescription" class="${getInputClasses()}" value="${recognizedData.description || ''}" ${loading ? 'disabled' : ''}>
                                    </div>
                                    <div>
                                        <label class="${getLabelClasses()}" for="recognizedType">Typ</label>
                                        <select id="recognizedType" class="${getInputClasses()}" ${loading ? 'disabled' : ''}>
                                            <option value="expense" ${recognizedData.type === 'expense' ? 'selected' : ''}>Ausgabe</option>
                                            <option value="income" ${recognizedData.type === 'income' ? 'selected' : ''}>Einnahme</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="${getLabelClasses()}" for="recognizedCategory">Kategorie</label>
                                        <select id="recognizedCategory" class="${getInputClasses()}" ${loading || currentCategories.length === 0 ? 'disabled' : ''}>
                                            ${currentCategories.length === 0 ? `<option value="">Keine Kategorien verfügbar</option>` :
                                                currentCategories.map(cat => `<option value="${cat.id}" ${recognizedData.categoryId === cat.id ? 'selected' : ''}>${cat.name}</option>`).join('')
                                            }
                                        </select>
                                    </div>
                                    <div>
                                        <label class="${getLabelClasses()}" for="recognizedDate">Datum</label>
                                        <input type="date" id="recognizedDate" class="${getInputClasses()}" value="${recognizedData.date || ''}" ${loading ? 'disabled' : ''}>
                                    </div>
                                </div>
                                <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4 mt-6">
                                    <button id="confirm-invoice-btn" class="${getButtonClasses(darkMode ? colors.darkGreen : colors.darkBlueGreen, darkMode ? colors.darkBlueGreen : colors.darkGreen)}" ${loading ? 'disabled' : ''}>
                                        ${loading ? 'Speichere...' : 'Bestätigen & Hinzufügen'}
                                    </button>
                                    <button id="cancel-review-btn" class="${getButtonClasses(darkMode ? 'gray-700' : colors.lightGrayBlue, darkMode ? 'gray-600' : 'gray-300')}" ${loading ? 'disabled' : ''}>
                                        Abbrechen
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;

                // Event Listener neu zuweisen
                const invoiceFileInput = document.getElementById('invoice-file-input');
                if (invoiceFileInput) {
                    invoiceFileInput.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            selectedFile = file;
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                imagePreviewUrl = event.target.result;
                                errorMessage = '';
                                recognizedData = null; // Reset recognized data
                                reviewMode = false; // Exit review mode
                                updateInvoiceUploadUI();
                            };
                            reader.readAsDataURL(file);
                        } else {
                            selectedFile = null;
                            imagePreviewUrl = '';
                            recognizedData = null;
                            reviewMode = false;
                            updateInvoiceUploadUI();
                        }
                    };
                }

                const analyzeInvoiceBtn = document.getElementById('analyze-invoice-btn');
                if (analyzeInvoiceBtn) analyzeInvoiceBtn.onclick = analyzeInvoice;

                // Event Listeners für Review-Modus
                if (reviewMode && recognizedData) {
                    document.getElementById('recognizedAmount').oninput = (e) => { recognizedData.amount = e.target.value; };
                    document.getElementById('recognizedDescription').oninput = (e) => { recognizedData.description = e.target.value; };
                    document.getElementById('recognizedType').onchange = (e) => { recognizedData.type = e.target.value; };
                    document.getElementById('recognizedCategory').onchange = (e) => { recognizedData.categoryId = e.target.value; };
                    document.getElementById('recognizedDate').oninput = (e) => { recognizedData.date = e.target.value; };

                    document.getElementById('confirm-invoice-btn').onclick = confirmInvoiceTransaction;
                    document.getElementById('cancel-review-btn').onclick = () => {
                        reviewMode = false;
                        recognizedData = null;
                        errorMessage = '';
                        updateInvoiceUploadUI();
                    };
                }
            };

            const analyzeInvoice = async () => {
                if (!selectedFile) {
                    errorMessage = "Bitte wählen Sie zuerst eine Rechnungsdatei aus.";
                    updateInvoiceUploadUI();
                    return;
                }

                loading = true;
                errorMessage = '';
                updateInvoiceUploadUI();

                try {
                    const reader = new FileReader();
                    reader.readAsDataURL(selectedFile);
                    reader.onloadend = async () => {
                        const base64ImageData = reader.result.split(',')[1]; // Nur den Base64-Teil extrahieren

                        const prompt = `Analysiere diese Rechnung. Extrahiere den Gesamtbetrag (total amount), eine kurze Beschreibung (description, z.B. Name des Geschäfts oder Art der Dienstleistung), den Transaktionstyp (type: 'income' oder 'expense'), und das Rechnungsdatum (date) im Format YYYY-MM-DD. Wenn es sich um eine Ausgabe handelt, schlage eine passende Kategorie-ID aus der folgenden Liste vor. Wenn keine Kategorie passt, schlage die erste Kategorie vor. Gib die Antwort als JSON-Array zurück, das ein Objekt mit diesen Feldern enthält.
                        Verfügbare Kategorien (ID: Name): ${currentCategories.map(cat => `${cat.id}: ${cat.name}`).join(', ')}.`;

                        const payload = {
                            contents: [
                                {
                                    role: "user",
                                    parts: [
                                        { text: prompt },
                                        {
                                            inlineData: {
                                                mimeType: selectedFile.type,
                                                data: base64ImageData
                                            }
                                        }
                                    ]
                                }
                            ],
                            generationConfig: {
                                responseMimeType: "application/json",
                                responseSchema: {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            "amount": { "type": "NUMBER" },
                                            "description": { "type": "STRING" },
                                            "type": { "type": "STRING", "enum": ["income", "expense"] },
                                            "date": { "type": "STRING" },
                                            "categoryId": { "type": "STRING" }
                                        },
                                        "required": ["amount", "description", "type", "date", "categoryId"]
                                    }
                                }
                            }
                        };

                        const apiKey = ""; // Canvas fügt API-Schlüssel zur Laufzeit ein
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const jsonText = result.candidates[0].content.parts[0].text;
                            const parsedJson = JSON.parse(jsonText);

                            if (parsedJson && parsedJson.length > 0) {
                                recognizedData = parsedJson[0];
                                // Sicherstellen, dass categoryId eine gültige ID ist
                                const validCategory = currentCategories.find(cat => cat.id === recognizedData.categoryId);
                                if (!validCategory && currentCategories.length > 0) {
                                    recognizedData.categoryId = currentCategories[0].id; // Fallback zur ersten Kategorie
                                } else if (currentCategories.length === 0) {
                                    recognizedData.categoryId = ''; // Keine Kategorie, wenn keine verfügbar
                                }
                                reviewMode = true; // Review-Modus aktivieren
                            } else {
                                errorMessage = "Keine Daten in der Rechnung erkannt. Bitte versuchen Sie es erneut oder geben Sie die Daten manuell ein.";
                            }
                        } else {
                            errorMessage = "Fehler bei der Rechnungsanalyse. Ungültige Antwort vom Server.";
                        }
                    };
                } catch (error) {
                    console.error("Fehler bei der Rechnungsanalyse:", error);
                    errorMessage = "Ein Fehler ist aufgetreten: " + error.message;
                } finally {
                    loading = false;
                    updateInvoiceUploadUI();
                }
            };

            const confirmInvoiceTransaction = async () => {
                errorMessage = '';
                if (!recognizedData || !recognizedData.amount || !recognizedData.description || !recognizedData.type || !recognizedData.date || !recognizedData.categoryId) {
                    errorMessage = "Bitte füllen Sie alle Felder aus oder korrigieren Sie die erkannten Daten.";
                    updateInvoiceUploadUI();
                    return;
                }

                loading = true;
                updateInvoiceUploadUI();

                try {
                    const transactionsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/transactions`);
                    await addDoc(transactionsCollectionRef, {
                        amount: parseFloat(recognizedData.amount),
                        description: recognizedData.description.trim(),
                        type: recognizedData.type,
                        categoryId: recognizedData.categoryId,
                        createdAt: new Date(recognizedData.date), // Verwende das erkannte Datum
                        userId: currentUserId,
                        source: 'invoice-upload'
                    });
                    errorMessage = "Transaktion erfolgreich hinzugefügt!";
                    selectedFile = null;
                    imagePreviewUrl = '';
                    recognizedData = null;
                    reviewMode = false;
                } catch (error) {
                    console.error("Fehler beim Hinzufügen der Rechnungs-Transaktion:", error);
                    errorMessage = "Fehler beim Hinzufügen der Transaktion: " + error.message;
                } finally {
                    loading = false;
                    updateInvoiceUploadUI();
                }
            };

            // Kategorien Listener (um currentCategories aktuell zu halten)
            onSnapshot(query(collection(db, `artifacts/${appId}/users/${currentUserId}/categories`)), (snapshot) => {
                currentCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Wenn im Review-Modus und Kategorie nicht mehr existiert, Fallback
                if (reviewMode && recognizedData && recognizedData.categoryId) {
                    const validCategory = currentCategories.find(cat => cat.id === recognizedData.categoryId);
                    if (!validCategory && currentCategories.length > 0) {
                        recognizedData.categoryId = currentCategories[0].id; // Fallback zur ersten Kategorie
                    } else if (currentCategories.length === 0) {
                        recognizedData.categoryId = '';
                    }
                }
                updateInvoiceUploadUI();
            }, (error) => {
                console.error("Fehler beim Abrufen der Kategorien für Rechnungs-Upload:", error);
                errorMessage = "Fehler beim Laden der Kategorien.";
                updateInvoiceUploadUI();
            });

            updateInvoiceUploadUI(); // Initialer Render
        }


        // --- Initialisierung und Event Listener ---
        document.addEventListener('DOMContentLoaded', () => {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    currentUserId = user.uid;
                    renderPage('dashboard');
                    document.getElementById('dark-mode-toggle').style.display = 'block'; // Dark Mode Button anzeigen
                } else {
                    currentUser = null;
                    currentUserId = null;
                    renderPage('login');
                    document.getElementById('dark-mode-toggle').style.display = 'none'; // Dark Mode Button verbergen
                }
                isAuthReady = true;
            });

            // Navigation Event Listener
            dashboardBtn.addEventListener('click', () => renderPage('dashboard'));
            categoriesBtn.addEventListener('click', () => renderPage('categories'));
            settingsBtn.addEventListener('click', () => renderPage('settings'));
            limitsBtn.addEventListener('click', () => renderPage('limits'));
            invoiceUploadBtn.addEventListener('click', () => renderPage('invoice-upload'));
            logoutBtn.addEventListener('click', async () => {
                await signOut(auth);
                currentUser = null;
                currentUserId = null;
                renderPage('login');
            });

            // Dark Mode Toggle
            darkModeToggle.addEventListener('click', () => {
                darkMode = !darkMode;
                applyDarkModeStyles();
                // Seite neu rendern, um Dark Mode auf dynamischen Inhalten anzuwenden
                if (currentUser) { // Nur wenn angemeldet, um Endlosschleife auf Login-Seite zu vermeiden
                    renderPage(getCurrentPageName());
                } else {
                    renderLoginPage(); // Login-Seite ist statisch genug
                }
            });

            // Initialen Dark Mode Zustand anwenden
            applyDarkModeStyles();

            // Hilfsfunktion, um den aktuellen Seitennamen zu erhalten (für Dark Mode Toggle)
            function getCurrentPageName() {
                const activeBtn = headerNavButtons.find(btn => btn.classList.contains(darkMode ? `bg-[${colors.darkGreen}]` : `bg-[${colors.darkGreen}]`));
                if (activeBtn) {
                    return activeBtn.id.replace('-btn', '');
                }
                return 'dashboard'; // Standardwert
            }
        });
    </script>
</body>
</html>
