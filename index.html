<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lehrlings-Budget</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        canvas {
            display: block;
            width: 100%;
            height: auto; /* Allow height to adjust based on aspect ratio or content */
            max-width: 100%;
        }
        /* Zus√§tzliche Stile f√ºr den Anmeldebereich, um ihn als separate "Seite" darzustellen */
        .login-page-container {
            min-height: calc(100vh - 6rem); /* Volle H√∂he minus Header-H√∂he */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem; /* Kleinerer Padding f√ºr den Login-Bereich */
        }
    </style>
</head>
<body class="min-h-screen bg-[#E7EAEF] text-gray-900 font-inter">

    <!-- Header -->
    <header id="app-header" class="p-4 shadow-md rounded-b-lg bg-[#177E89] text-white">
        <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-3xl font-bold mb-2 sm:mb-0">Lehrlings-Budget</h1>
            <nav class="w-full sm:w-auto">
                <ul id="header-nav-list" class="flex flex-wrap justify-center sm:justify-end gap-2 sm:space-x-4">
                    <li><button id="dashboard-btn" class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-sm sm:text-base transition-colors duration-200">Dashboard</button></li>
                    <li><button id="categories-btn" class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-sm sm:text-base transition-colors duration-200">Kategorien</button></li>
                    <li><button id="settings-btn" class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-sm sm:text-base transition-colors duration-200">Einstellungen</button></li>
                    <li><button id="limits-btn" class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-sm sm:text-base transition-colors duration-200">Budgetgrenzen</button></li>
                    <li><button id="savings-goals-btn" class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-sm sm:text-base transition-colors duration-200">Sparziele</button></li>
                    <li><button id="invoice-analysis-btn" class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-sm sm:text-base transition-colors duration-200">Rechnungen</button></li>
                    <li><button id="logout-btn" class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-sm sm:text-base bg-red-500 hover:bg-red-600 transition-colors duration-200">Abmelden</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Hauptinhalt -->
    <main id="main-content" class="container mx-auto p-4 sm:p-6">
        <!-- Inhalte werden hier dynamisch geladen -->
    </main>

    <!-- Reward Modal -->
    <div id="reward-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-70 z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl text-center max-w-sm w-full">
            <h3 class="text-3xl font-bold text-[#08605F] mb-4">Ziel erreicht! üéâ</h3>
            <p id="reward-message" class="text-lg text-gray-800 mb-6">Herzlichen Gl√ºckwunsch! Du hast dein Sparziel erfolgreich erreicht!</p>
            <button id="close-reward-modal" class="bg-[#177E89] hover:bg-[#08605F] text-white font-bold py-2 px-5 rounded-lg transition-all duration-200">Super!</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, deleteDoc, onSnapshot, query, where, orderBy, serverTimestamp, getDocs, writeBatch, setDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Deine Firebase Konfiguration
        const firebaseConfig = {
          apiKey: "AIzaSyBX_aHaadvBz08hcVUz-_qLVP0a16N3R3s",
          authDomain: "budgettierung-lehre.firebaseapp.com",
          projectId: "budgettierung-lehre",
          storageBucket: "budgettierung-lehre.firebasestorage.app",
          messagingSenderId: "993511841399",
          appId: "1:993511841399:web:811a030fa95465af20b072",
          measurementId: "G-M2MV5B2SDT"
        };

        const appId = firebaseConfig.appId || 'default-app-id';

        let app;
        let auth;
        let db;
        let currentUser = null;
        let currentUserId = null;
        let isAuthReady = false;
        let currentCategories = []; // Globaler Cache f√ºr Kategorien
        let dashboardSettings = {}; // Globales Objekt f√ºr Dashboard-Einstellungen
        let dashboardSettingsDocRef; // Globale Referenz zum Firestore-Dokument

        // Farbpalette
        const colors = {
            caribbeanCurrent: '#08605F',
            teal: '#177E89',
            hookersGreen: '#598381',
            mossGreen: '#8E936D',
            olivine: '#A2AD59',

            // Definierte Tailwind-Klassennamen f√ºr dynamische Verwendung
            tailwind: {
                bgCaribbeanCurrent: 'bg-[#08605F]',
                bgTeal: 'bg-[#177E89]',
                bgHookersGreen: 'bg-[#598381]',
                bgMossGreen: 'bg-[#8E936D]',
                bgOlivine: 'bg-[#A2AD59]',
                textCaribbeanCurrent: 'text-[#08605F]',
                textTeal: 'text-[#177E89]',
                textHookersGreen: 'text-[#598381]',
                textMossGreen: 'text-[#8E936D]',
                textOlivine: 'text-[#A2AD59]',
                borderMossGreen: 'border-[#8E936D]',
                focusRingMossGreen: 'focus:ring-[#8E936D]',
                hoverBgCaribbeanCurrent: 'hover:bg-[#08605F]',
                hoverBgTeal: 'hover:bg-[#177E89]',
                bgRed500: 'bg-red-500',
                hoverBgRed600: 'hover:bg-red-600',
                bgRed600: 'bg-red-600',
                hoverBgRed700: 'hover:bg-red-700',
                bgRed800: 'bg-red-800',
                bgYellow100: 'bg-yellow-100',
                textRed700: 'text-red-700',
                textYellow600: 'text-yellow-600',
                textRed800: 'text-red-800',
            }
        };

        // DOM-Elemente
        const appHeader = document.getElementById('app-header'); // Referenz zum Header
        const mainContent = document.getElementById('main-content');
        const dashboardBtn = document.getElementById('dashboard-btn');
        const categoriesBtn = document.getElementById('categories-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const limitsBtn = document.getElementById('limits-btn');
        const savingsGoalsBtn = document.getElementById('savings-goals-btn');
        const invoiceAnalysisBtn = document.getElementById('invoice-analysis-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const headerNavButtons = [dashboardBtn, categoriesBtn, settingsBtn, limitsBtn, savingsGoalsBtn, invoiceAnalysisBtn, logoutBtn];

        const rewardModal = document.getElementById('reward-modal');
        const rewardMessage = document.getElementById('reward-message');
        const closeRewardModalBtn = document.getElementById('close-reward-modal');

        // --- Hilfsfunktionen f√ºr UI-Updates ---
        function updateHeaderNavButtons(activePageId, isLoggedIn) {
            const baseBtnClasses = "px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-sm sm:text-base transition-colors duration-200";

            if (!isLoggedIn) {
                appHeader.classList.add('hidden'); // Header komplett ausblenden
            } else {
                appHeader.classList.remove('hidden'); // Header einblenden
            }

            headerNavButtons.forEach(button => {
                let currentBtnClasses = baseBtnClasses;
                let shouldHide = false;

                if (!isLoggedIn) {
                    shouldHide = true; // Hide all nav buttons if not logged in
                }

                if (button.id === 'logout-btn') {
                    if (!isLoggedIn) {
                        shouldHide = true;
                    }
                    currentBtnClasses += ` ${colors.tailwind.bgRed500} ${colors.tailwind.hoverBgRed600}`;
                } else if (isLoggedIn) {
                    if (button.id.startsWith(activePageId)) {
                        currentBtnClasses += ` ${colors.tailwind.bgCaribbeanCurrent} text-white`;
                    } else {
                        currentBtnClasses += ` hover:bg-[#08605F] text-white`;
                    }
                }

                if (shouldHide) {
                    button.classList.add('hidden');
                } else {
                    button.classList.remove('hidden');
                }
                button.className = currentBtnClasses;
            });
        }

        function getCardClasses() {
            return `p-6 sm:p-8 rounded-xl shadow-lg border bg-white ${colors.tailwind.borderMossGreen} text-gray-900`;
        }

        function getInnerCardClasses() {
            return `mb-8 p-4 sm:p-6 rounded-lg border ${colors.tailwind.bgHookersGreen} ${colors.tailwind.borderMossGreen}`;
        }

        function getInputClasses() {
            return `shadow appearance-none border rounded-lg w-full py-2.5 px-3 sm:py-3 sm:px-4 leading-tight focus:outline-none focus:ring-2 bg-white text-gray-700 ${colors.tailwind.borderMossGreen} ${colors.tailwind.focusRingMossGreen}`;
        }

        function getButtonClasses(baseBgClass, hoverBgClass) {
            const textColorClass = 'text-white';

            return `font-bold py-2.5 px-5 sm:py-3 sm:px-6 rounded-lg text-base sm:text-lg focus:outline-none focus:shadow-outline transition-all duration-200 transform hover:scale-105 ${baseBgClass} ${hoverBgClass} ${textColorClass}`;
        }

        function getLabelClasses() {
            return `block text-sm font-semibold mb-2 text-gray-700`;
        }

        function getTitleClasses() {
            return `text-2xl sm:text-3xl font-bold mb-6 text-center text-gray-800`;
        }

        function getSubtitleClasses() {
            return `text-xl font-semibold mb-4 ${colors.tailwind.textCaribbeanCurrent}`;
        }

        function getItalicTextClasses() {
            return `italic text-gray-600`;
        }

        function getListItemClasses() {
            return `flex items-center justify-between p-4 rounded-md shadow-sm border ${colors.tailwind.bgOlivine} ${colors.tailwind.borderMossGreen} text-gray-900`;
        }

        function getIncomeTextClasses() {
            return `text-lg font-medium ${colors.tailwind.textCaribbeanCurrent}`;
        }

        function getExpenseTextClasses() {
            return `text-lg font-medium text-red-600`;
        }

        function getSmallTextClasses() {
            return `text-sm text-gray-700`;
        }

        function getXSmallTextClasses() {
            return `text-xs text-gray-500`;
        }

        // --- Allgemeine App-Logik ---
        async function renderPage(pageName) {
            mainContent.innerHTML = ''; // Inhalt leeren

            // Klassen f√ºr mainContent anpassen je nach Seite
            if (pageName === 'login') {
                mainContent.classList.add('login-page-container');
                mainContent.classList.remove('container', 'mx-auto', 'p-4', 'sm:p-6');
            } else {
                mainContent.classList.remove('login-page-container');
                mainContent.classList.add('container', 'mx-auto', 'p-4', 'sm:p-6');
            }

            updateHeaderNavButtons(pageName, currentUser !== null);

            if (!currentUser && pageName !== 'login') {
                renderLoginPage();
                return;
            }

            switch (pageName) {
                case 'login':
                    renderLoginPage();
                    break;
                case 'dashboard':
                    await renderDashboardPage();
                    break;
                case 'categories':
                    await renderCategoriesPage();
                    break;
                case 'settings':
                    await renderSettingsPage();
                    break;
                case 'limits':
                    await renderBudgetLimitsPage();
                    break;
                case 'savings-goals':
                    await renderSavingsGoalsPage();
                    break;
                case 'invoice-analysis':
                    await renderInvoiceAnalysisPage();
                    break;
                default:
                    renderLoginPage();
            }
        }

        // --- Auth-Seite ---
        function renderLoginPage() {
            let email = '';
            let password = '';
            let isRegistering = false;
            let rememberMe = true;
            let errorMessage = '';
            let loading = false;

            const updateUI = () => {
                mainContent.innerHTML = `
                    <div class="${getCardClasses()} max-w-md w-full">
                        <h2 class="${getTitleClasses()}">
                            ${isRegistering ? 'Registrieren' : 'Anmelden'}
                        </h2>
                        ${errorMessage ? `<div class="bg-red-100 border border-red-400 ${colors.tailwind.textRed700} px-4 py-3 rounded-md relative mb-4" role="alert">
                            <strong class="font-bold">Fehler!</strong>
                            <span class="block sm:inline"> ${errorMessage}</span>
                        </div>` : ''}
                        <div class="mb-4">
                            <label class="${getLabelClasses()}" for="email">E-Mail</label>
                            <input type="email" id="email" class="${getInputClasses()}" placeholder="deine.email@example.com" value="${email}" ${loading ? 'disabled' : ''}>
                        </div>
                        <div class="mb-6">
                            <label class="${getLabelClasses()}" for="password">Passwort</label>
                            <input type="password" id="password" class="${getInputClasses()}" placeholder="********" value="${password}" ${loading ? 'disabled' : ''}>
                        </div>
                        <div class="mb-6 flex items-center">
                            <input type="checkbox" id="remember-me" class="mr-2 h-4 w-4 text-[#177E89] focus:ring-[#177E89] border-gray-300 rounded" ${rememberMe ? 'checked' : ''} ${loading ? 'disabled' : ''}>
                            <label for="remember-me" class="text-sm text-gray-700">Eingeloggt bleiben</label>
                        </div>
                        <div class="flex flex-col space-y-3 sm:space-y-4">
                            <button id="auth-action-btn" class="${getButtonClasses(colors.tailwind.bgTeal, colors.tailwind.hoverBgCaribbeanCurrent)}" ${loading ? 'disabled' : ''}>
                                ${loading ? 'Lade...' : (isRegistering ? 'Registrieren' : 'Anmelden')}
                            </button>
                            <button id="toggle-register-btn" class="${getButtonClasses('bg-gray-200', 'hover:bg-gray-300')} text-gray-800">
                                ${isRegistering ? 'Ich habe bereits ein Konto' : 'Ich habe noch kein Konto'}
                            </button>
                        </div>
                    </div>
                `;

                document.getElementById('email').oninput = (e) => { email = e.target.value; };
                document.getElementById('password').oninput = (e) => { password = e.target.value; };
                document.getElementById('remember-me').onchange = (e) => { rememberMe = e.target.checked; };
                document.getElementById('auth-action-btn').onclick = handleAuthAction;
                document.getElementById('toggle-register-btn').onclick = () => {
                    isRegistering = !isRegistering;
                    errorMessage = '';
                    updateUI();
                };
            };

            const handleAuthAction = async () => {
                loading = true;
                errorMessage = '';
                updateUI();

                try {
                    await setPersistence(auth, rememberMe ? browserLocalPersistence : browserSessionPersistence);

                    if (isRegistering) {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        currentUser = userCredential.user;
                        currentUserId = userCredential.user.uid;
                        renderPage('dashboard');
                    } else {
                        const userCredential = await signInWithEmailAndPassword(auth, email, password);
                        currentUser = userCredential.user;
                        currentUserId = userCredential.user.uid;
                        renderPage('dashboard');
                    }
                } catch (error) {
                    console.error("Auth Fehler:", error);
                    let msg = "Ein unbekannter Fehler ist aufgetreten.";
                    if (error.code === 'auth/invalid-email') {
                        msg = "Ung√ºltige E-Mail-Adresse.";
                    } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        msg = "E-Mail oder Passwort ist falsch.";
                    } else if (error.code === 'auth/email-already-in-use') {
                        msg = "Diese E-Mail-Adresse wird bereits verwendet.";
                    } else if (error.code === 'auth/weak-password') {
                        msg = "Das Passwort ist zu schwach (mind. 6 Zeichen).";
                    } else if (error.code === 'auth/requests-to-this-api-identitytoolkit-method-google.cloud.identitytoolkit.v1.authenticationservice.signinwithpassword-are-blocked.') {
                        msg = "Authentifizierungsanfrage blockiert. Bitte stellen Sie sicher, dass die E-Mail/Passwort-Anmeldung in Ihrem Firebase-Projekt aktiviert ist und Ihre API-Schl√ºssel korrekt konfiguriert sind.";
                    }
                    errorMessage = msg;
                } finally {
                    loading = false;
                    updateUI();
                }
            };

            updateUI();
        }

        // Helper to calculate next due date for recurring transactions
        function calculateNextDueDate(recurring) {
            const today = new Date();
            let nextDueDate = new Date();
            nextDueDate.setHours(0, 0, 0, 0);

            if (recurring.frequency === 'monthly') {
                const day = recurring.recurringDay || 1;
                nextDueDate.setDate(day);
                if (nextDueDate < today) {
                    nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                    if (nextDueDate.getDate() !== day) {
                        nextDueDate.setDate(0);
                    }
                }
            } else if (recurring.frequency === 'weekly') {
                const createdDate = recurring.createdAt ? recurring.createdAt.toDate() : new Date();
                const dayOfWeek = createdDate.getDay();
                let daysUntilNext = (dayOfWeek - today.getDay() + 7) % 7;
                if (daysUntilNext === 0 && today > createdDate) {
                    daysUntilNext = 7;
                }
                nextDueDate.setDate(today.getDate() + daysUntilNext);
            } else if (recurring.frequency === 'yearly') {
                const createdDate = recurring.createdAt ? recurring.createdAt.toDate() : new Date();
                nextDueDate.setMonth(createdDate.getMonth());
                nextDueDate.setDate(createdDate.getDate());
                if (nextDueDate < today) {
                    nextDueDate.setFullYear(nextDueDate.getFullYear() + 1);
                }
            }
            return nextDueDate;
        }

        // Function to get monthly expenses for charting
        function getMonthlyExpenses(transactionsData, numMonths = 6) {
            const monthlyData = {};
            const today = new Date();

            for (let i = 0; i < numMonths; i++) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const yearMonth = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[yearMonth] = 0;
            }

            transactionsData.forEach(t => {
                if (t.type === 'expense' && t.createdAt && t.createdAt.toDate) {
                    const date = t.createdAt.toDate();
                    const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (monthlyData.hasOwnProperty(yearMonth)) {
                        monthlyData[yearMonth] += t.amount;
                    }
                }
            });

            const sortedMonthlyData = Object.keys(monthlyData)
                .sort()
                .map(key => ({
                    month: key,
                    amount: monthlyData[key]
                }));

            return sortedMonthlyData;
        }

        // Function to draw the bar chart
        function drawBarChart(canvasId, data) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const padding = 40;
            const chartWidth = canvas.width - 2 * padding;
            const chartHeight = canvas.height - 2 * padding;

            const barWidth = chartWidth / (data.length * 1.5);
            const barSpacing = barWidth / 2;

            const maxAmount = Math.max(...data.map(d => d.amount)) * 1.1;
            if (maxAmount === 0) {
                ctx.font = '16px Inter';
                ctx.fillStyle = colors.caribbeanCurrent;
                ctx.textAlign = 'center';
                ctx.fillText('Keine Ausgabendaten f√ºr den Trend verf√ºgbar.', canvas.width / 2, canvas.height / 2);
                return;
            }

            // Draw Y-axis
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.strokeStyle = '#333';
            ctx.stroke();

            // Draw X-axis
            ctx.beginPath();
            ctx.moveTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.strokeStyle = '#333';
            ctx.stroke();

            // Draw bars
            data.forEach((item, index) => {
                const barHeight = (item.amount / maxAmount) * chartHeight;
                const x = padding + (index * (barWidth + barSpacing)) + barSpacing / 2;
                const y = canvas.height - padding - barHeight;

                // Bar
                ctx.fillStyle = colors.teal;
                ctx.fillRect(x, y, barWidth, barHeight);

                // Label (amount) above bar
                ctx.font = '12px Inter';
                ctx.fillStyle = '#333';
                ctx.textAlign = 'center';
                ctx.fillText(item.amount.toFixed(2), x + barWidth / 2, y - 5);

                // X-axis label (month)
                ctx.font = '10px Inter';
                ctx.fillStyle = '#555';
                ctx.textAlign = 'center';
                const monthLabel = item.month.split('-')[1];
                ctx.fillText(monthLabel, x + barWidth / 2, canvas.height - padding + 15);
            });

            // Y-axis labels (simple max value)
            ctx.font = '12px Inter';
            ctx.fillStyle = '#333';
            ctx.textAlign = 'right';
            ctx.fillText(maxAmount.toFixed(0) + ' CHF', padding - 5, padding);
            ctx.fillText('0 CHF', padding - 5, canvas.height - padding + 5);
        }

        // --- Dashboard-Seite ---
        async function renderDashboardPage() {
            let transactions = [];
            let recurringTransactions = [];
            let newAmount = '';
            let newDescription = '';
            let newType = 'expense';
            let newCategoryId = currentCategories.length > 0 ? currentCategories[0].id : '';
            let errorMessage = '';
            let loading = false;
            let showResetConfirmation = false;

            const categoriesCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/categories`);
            const transactionsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/transactions`);
            const recurringTransactionsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/recurringTransactions`);

            const updateDashboardUI = () => {
                const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const balance = totalIncome - totalExpense;

                const upcomingPayments = recurringTransactions
                    .map(rec => ({
                        ...rec,
                        nextDueDate: calculateNextDueDate(rec)
                    }))
                    .filter(rec => {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const thirtyDaysFromNow = new Date();
                        thirtyDaysFromNow.setDate(today.getDate() + 30);
                        thirtyDaysFromNow.setHours(23, 59, 59, 999);
                        return rec.nextDueDate >= today && rec.nextDueDate <= thirtyDaysFromNow;
                    })
                    .sort((a, b) => a.nextDueDate - b.nextDueDate);

                const top5Expenses = transactions
                    .filter(t => t.type === 'expense')
                    .sort((a, b) => b.amount - a.amount)
                    .slice(0, 5);

                mainContent.innerHTML = `
                    <div class="${getCardClasses()} max-w-3xl mx-auto">
                        <h2 class="${getTitleClasses()}">Dein Budget-Dashboard</h2>

                        ${errorMessage ? `<div class="bg-red-100 border border-red-400 ${colors.tailwind.textRed700} px-4 py-3 rounded-md relative mb-4" role="alert">
                            <strong class="font-bold">Fehler!</strong>
                            <span class="block sm:inline"> ${errorMessage}</span>
                        </div>` : ''}

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 text-center">
                            <div class="p-4 rounded-lg shadow-sm ${colors.tailwind.bgCaribbeanCurrent} text-white">
                                <p class="text-lg">Einnahmen</p>
                                <p class="text-2xl font-bold">${totalIncome.toFixed(2)} CHF</p>
                            </div>
                            <div class="p-4 rounded-lg shadow-sm ${colors.tailwind.bgRed800} text-white">
                                <p class="text-lg">Ausgaben</p>
                                <p class="text-2xl font-bold">${totalExpense.toFixed(2)} CHF</p>
                            </div>
                            <div class="p-4 rounded-lg shadow-sm ${balance >= 0
                                ? `${colors.tailwind.bgCaribbeanCurrent} text-white`
                                : `${colors.tailwind.bgYellow100} ${colors.tailwind.textYellow600}`
                            }">
                                <p class="text-lg">Saldo</p>
                                <p class="text-2xl font-bold">${balance.toFixed(2)} CHF</p>
                            </div>
                        </div>

                        ${dashboardSettings.showAddTransaction ? `
                            <div class="${getInnerCardClasses()}">
                                <h3 class="${getSubtitleClasses()}">Neue Transaktion hinzuf√ºgen</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="${getLabelClasses()}" for="amount">Betrag (CHF)</label>
                                        <input type="number" id="amount" class="${getInputClasses()}" placeholder="z.B. 50.00" value="${newAmount}" ${loading ? 'disabled' : ''}>
                                    </div>
                                    <div>
                                        <label class="${getLabelClasses()}" for="description">Beschreibung</label>
                                        <input type="text" id="description" class="${getInputClasses()}" placeholder="z.B. Lohn Juli" value="${newDescription}" ${loading ? 'disabled' : ''}>
                                    </div>
                                    <div>
                                        <label class="${getLabelClasses()}" for="type">Typ</label>
                                        <select id="type" class="${getInputClasses()}" ${loading ? 'disabled' : ''}>
                                            <option value="expense" ${newType === 'expense' ? 'selected' : ''}>Ausgabe</option>
                                            <option value="income" ${newType === 'income' ? 'selected' : ''}>Einnahme</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="${getLabelClasses()}" for="category">Kategorie</label>
                                        <select id="category" class="${getInputClasses()}" ${loading || currentCategories.length === 0 ? 'disabled' : ''}>
                                            ${currentCategories.length === 0 ? `<option value="">Keine Kategorien verf√ºgbar</option>` :
                                                currentCategories.map(cat => `<option value="${cat.id}" ${newCategoryId === cat.id ? 'selected' : ''}>${cat.name}</option>`).join('')
                                            }
                                        </select>
                                    </div>
                                </div>
                                <button id="add-transaction-btn" class="w-full ${getButtonClasses(colors.tailwind.bgTeal, colors.tailwind.hoverBgCaribbeanCurrent)}" ${loading || currentCategories.length === 0 ? 'disabled' : ''}>
                                    ${loading ? 'Hinzuf√ºgen...' : 'Transaktion hinzuf√ºgen'}
                                </button>
                                ${currentCategories.length === 0 ? `<p class="text-sm text-red-500 mt-2 text-center">Bitte f√ºge zuerst Kategorien im Reiter "Kategorien" hinzu, um Transaktionen zu erfassen.</p>` : ''}
                            </div>
                        ` : ''}

                        ${dashboardSettings.showUpcomingPayments ? `
                            <div class="${getInnerCardClasses()}">
                                <h3 class="${getSubtitleClasses()}">Bevorstehende wiederkehrende Zahlungen (N√§chste 30 Tage)</h3>
                                ${upcomingPayments.length === 0 ? `<p class="${getItalicTextClasses()}">Keine bevorstehenden wiederkehrenden Zahlungen.</p>` : `
                                    <ul class="space-y-3">
                                        ${upcomingPayments.map(t => `
                                            <li class="${getListItemClasses()}">
                                                <div>
                                                    <span class="text-lg font-medium">
                                                        ${t.name}: ${t.type === 'income' ? '+' : '-'} ${t.amount.toFixed(2)} CHF
                                                    </span>
                                                    <p class="${getXSmallTextClasses()}">
                                                        Kategorie: ${currentCategories.find(cat => cat.id === t.categoryId)?.name || 'Unbekannt'} | F√§llig: ${t.nextDueDate.toLocaleDateString()}
                                                    </p>
                                                </div>
                                            </li>
                                        `).join('')}
                                    </ul>
                                `}
                            </div>
                        ` : ''}

                        ${dashboardSettings.showTopExpenses ? `
                            <div class="${getInnerCardClasses()}">
                                <h3 class="${getSubtitleClasses()}">Top 5 gr√∂sste Ausgaben</h3>
                                ${top5Expenses.length === 0 ? `<p class="${getItalicTextClasses()}">Noch keine Ausgaben erfasst.</p>` : `
                                    <ul class="space-y-3">
                                        ${top5Expenses.map(t => `
                                            <li class="${getListItemClasses()}">
                                                <div>
                                                    <span class="${getExpenseTextClasses()}">
                                                        - ${t.amount.toFixed(2)} CHF
                                                    </span>
                                                    <p class="${getSmallTextClasses()}">${t.description}</p>
                                                    <p class="${getXSmallTextClasses()}">
                                                        Kategorie: ${currentCategories.find(cat => cat.id === t.categoryId)?.name || 'Unbekannt'}
                                                        ${t.createdAt && t.createdAt.toDate ? ` | ${new Date(t.createdAt.toDate()).toLocaleDateString()}` : ''}
                                                    </p>
                                                </div>
                                            </li>
                                        `).join('')}
                                    </ul>
                                `}
                            </div>
                        ` : ''}

                        ${dashboardSettings.showExpenseTrend ? `
                            <div class="${getInnerCardClasses()}">
                                <h3 class="${getSubtitleClasses()}">Ausgaben-Trend (Letzte 6 Monate)</h3>
                                <div class="flex justify-center">
                                    <canvas id="expenseTrendChart" class="w-full h-auto"></canvas>
                                </div>
                            </div>
                        ` : ''}

                        ${dashboardSettings.showRecentTransactions ? `
                            <div class="${getInnerCardClasses()}">
                                <h3 class="${getSubtitleClasses()}">Letzte Transaktionen</h3>
                                ${transactions.length === 0 ? `<p class="${getItalicTextClasses()}">Noch keine Transaktionen vorhanden.</p>` : `
                                    <ul class="space-y-3">
                                        ${transactions.map(t => `
                                            <li class="${getListItemClasses()}">
                                                <div>
                                                    <span class="${t.type === 'income' ? getIncomeTextClasses() : getExpenseTextClasses()}">
                                                        ${t.type === 'income' ? '+' : '-'} ${t.amount.toFixed(2)} CHF
                                                    </span>
                                                    <p class="${getSmallTextClasses()}">${t.description}</p>
                                                    <p class="${getXSmallTextClasses()}">
                                                        Kategorie: ${currentCategories.find(cat => cat.id === t.categoryId)?.name || 'Unbekannt'}
                                                        ${t.createdAt && t.createdAt.toDate ? ` | ${new Date(t.createdAt.toDate()).toLocaleDateString()}` : ''}
                                                    </p>
                                                </div>
                                            </li>
                                        `).join('')}
                                    </ul>
                                `}
                            </div>
                        ` : ''}

                        <div class="mt-6 sm:mt-8 text-center">
                            <button id="reset-dashboard-btn" class="${getButtonClasses(colors.tailwind.bgMossGreen, colors.tailwind.hoverBgCaribbeanCurrent)}" ${loading ? 'disabled' : ''}>
                                Dashboard zur√ºcksetzen
                            </button>
                        </div>
                    </div>

                    ${showResetConfirmation ? `
                        <div class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 p-4">
                            <div class="${getCardClasses()} max-w-sm sm:max-w-md w-full text-center">
                                <h3 class="${getSubtitleClasses()} text-xl sm:text-2xl">Dashboard zur√ºcksetzen?</h3>
                                <p class="mb-5 sm:mb-6 text-sm sm:text-base text-gray-700">
                                    Bist du sicher, dass du alle deine Transaktionen l√∂schen m√∂chtest? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.
                                </p>
                                <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                                    <button id="confirm-reset-btn" class="${colors.tailwind.bgRed600} ${colors.tailwind.hoverBgRed700} text-white font-bold py-2 px-4 sm:py-2.5 sm:px-5 rounded-lg text-sm sm:text-base transition-all duration-200" ${loading ? 'disabled' : ''}>
                                        Ja, l√∂schen
                                    </button>
                                    <button id="cancel-reset-btn" class="${getButtonClasses('bg-gray-200', 'hover:bg-gray-300')} text-gray-800" ${loading ? 'disabled' : ''}>
                                        Abbrechen
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                `;

                // Event Listener neu zuweisen
                const amountInput = document.getElementById('amount');
                if (amountInput) amountInput.oninput = (e) => { newAmount = e.target.value; };
                const descriptionInput = document.getElementById('description');
                if (descriptionInput) descriptionInput.oninput = (e) => { newDescription = e.target.value; };
                const typeSelect = document.getElementById('type');
                if (typeSelect) typeSelect.onchange = (e) => { newType = e.target.value; };
                const categorySelect = document.getElementById('category');
                if (categorySelect) categorySelect.onchange = (e) => { newCategoryId = e.target.value; };

                const addTransactionBtn = document.getElementById('add-transaction-btn');
                if (addTransactionBtn) addTransactionBtn.onclick = handleAddTransaction;

                const resetDashboardBtn = document.getElementById('reset-dashboard-btn');
                if (resetDashboardBtn) resetDashboardBtn.onclick = () => { showResetConfirmation = true; updateDashboardUI(); };

                const confirmResetBtn = document.getElementById('confirm-reset-btn');
                if (confirmResetBtn) confirmResetBtn.onclick = confirmResetDashboard;

                const cancelResetBtn = document.getElementById('cancel-reset-btn');
                if (cancelResetBtn) cancelResetBtn.onclick = () => { showResetConfirmation = false; updateDashboardUI(); };

                // Draw chart if visible
                if (dashboardSettings.showExpenseTrend) {
                    setTimeout(() => {
                        const monthlyExpenseData = getMonthlyExpenses(transactions);
                        drawBarChart('expenseTrendChart', monthlyExpenseData);
                    }, 0);
                }
            };

            const handleAddTransaction = async () => {
                errorMessage = '';
                if (newAmount === '' || isNaN(parseFloat(newAmount)) || parseFloat(newAmount) <= 0) {
                    errorMessage = "Bitte einen g√ºltigen Betrag eingeben.";
                    updateDashboardUI(); return;
                }
                if (newDescription.trim() === '') {
                    errorMessage = "Bitte eine Beschreibung eingeben.";
                    updateDashboardUI(); return;
                }
                if (newCategoryId === '' && currentCategories.length > 0) {
                    errorMessage = "Bitte eine Kategorie ausw√§hlen.";
                    updateDashboardUI(); return;
                }

                loading = true;
                updateDashboardUI();
                try {
                    await addDoc(transactionsCollectionRef, {
                        amount: parseFloat(newAmount),
                        description: newDescription.trim(),
                        type: newType,
                        categoryId: newCategoryId,
                        createdAt: serverTimestamp(),
                        userId: currentUserId
                    });
                    newAmount = '';
                    newDescription = '';
                } catch (error) {
                    console.error("Fehler beim Hinzuf√ºgen der Transaktion:", error);
                    errorMessage = "Fehler beim Hinzuf√ºgen der Transaktion.";
                } finally {
                    loading = false;
                    updateDashboardUI();
                }
            };

            const confirmResetDashboard = async () => {
                loading = true;
                errorMessage = '';
                showResetConfirmation = false;
                updateDashboardUI();

                try {
                    const q = query(transactionsCollectionRef);
                    const querySnapshot = await getDocs(q);
                    const batch = writeBatch(db);

                    querySnapshot.docs.forEach((document) => {
                        batch.delete(document.ref);
                    });

                    await batch.commit();
                    console.log("Dashboard erfolgreich zur√ºckgesetzt (alle Transaktionen gel√∂scht).");
                } catch (error) {
                    console.error("Fehler beim Zur√ºcksetzen des Dashboards:", error);
                    errorMessage = "Fehler beim Zur√ºcksetzen des Dashboards: " + error.message;
                } finally {
                    loading = false;
                    updateDashboardUI();
                }
            };

            // Listener f√ºr Transaktionen
            onSnapshot(query(transactionsCollectionRef, orderBy('createdAt', 'desc')), (snapshot) => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateDashboardUI();
            }, (error) => {
                console.error("Fehler beim Abrufen der Transaktionen:", error);
                errorMessage = "Fehler beim Laden der Transaktionen.";
                updateDashboardUI();
            });

            // Listener f√ºr wiederkehrende Transaktionen
            onSnapshot(query(recurringTransactionsCollectionRef), (snapshot) => {
                recurringTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateDashboardUI();
            }, (error) => {
                console.error("Fehler beim Abrufen der wiederkehrenden Transaktionen:", error);
                errorMessage = "Fehler beim Laden der wiederkehrenden Transaktionen.";
                updateDashboardUI();
            });

            // Listener f√ºr Kategorien (falls noch nicht global geladen)
            onSnapshot(query(categoriesCollectionRef), (snapshot) => {
                currentCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (newCategoryId === '' && currentCategories.length > 0) {
                    newCategoryId = currentCategories[0].id;
                }
                updateDashboardUI();
            }, (error) => {
                console.error("Fehler beim Abrufen der Kategorien:", error);
                errorMessage = "Fehler beim Laden der Kategorien.";
                updateDashboardUI();
            });

            // Automatische Hinzuf√ºgung wiederkehrender Transaktionen
            const addRecurringTransactions = async () => {
                try {
                    const q = query(recurringTransactionsCollectionRef);
                    const querySnapshot = await getDocs(q);
                    const batch = writeBatch(db);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    for (const docSnapshot of querySnapshot.docs) {
                        const recurring = docSnapshot.data();
                        const recurringId = docSnapshot.id;

                        let lastAppliedDate = recurring.lastAppliedDate && recurring.lastAppliedDate.toDate ? recurring.lastAppliedDate.toDate() : null;
                        if (lastAppliedDate) {
                            lastAppliedDate.setHours(0, 0, 0, 0);
                        }

                        const nextDueDate = calculateNextDueDate(recurring);

                        let shouldAdd = false;

                        if (nextDueDate <= today) {
                            if (!lastAppliedDate || lastAppliedDate < nextDueDate) {
                                shouldAdd = true;
                            }
                        }

                        if (shouldAdd) {
                            const newTransactionRef = doc(transactionsCollectionRef);
                            batch.set(newTransactionRef, {
                                amount: recurring.amount,
                                description: `(Wiederkehrend) ${recurring.name}`,
                                type: recurring.type,
                                categoryId: recurring.categoryId,
                                createdAt: serverTimestamp(),
                                userId: currentUserId,
                                recurringSourceId: recurringId,
                            });

                            batch.update(doc(recurringTransactionsCollectionRef, recurringId), {
                                lastAppliedDate: serverTimestamp(),
                            });
                        }
                    }
                    await batch.commit();
                    console.log("Wiederkehrende Transaktionen erfolgreich angewendet.");
                } catch (error) {
                    console.error("Fehler beim automatischen Hinzuf√ºgen wiederkehrender Transaktionen:", error);
                }
            };

            addRecurringTransactions();
        }

        // --- Kategorien-Seite ---
        async function renderCategoriesPage() {
            let categories = [];
            let newCategoryName = '';
            let errorMessage = '';
            let loading = false;

            const categoriesCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/categories`);

            const updateCategoriesUI = () => {
                mainContent.innerHTML = `
                    <div class="${getCardClasses()} max-w-2xl mx-auto">
                        <h2 class="${getTitleClasses()}">Kategorien verwalten</h2>

                        ${errorMessage ? `<div class="bg-red-100 border border-red-400 ${colors.tailwind.textRed700} px-4 py-3 rounded-md relative mb-4" role="alert">
                            <strong class="font-bold">Fehler!</strong>
                            <span class="block sm:inline"> ${errorMessage}</span>
                        </div>` : ''}

                        <div class="${getInnerCardClasses()}">
                            <h3 class="${getSubtitleClasses()}">Neue Kategorie hinzuf√ºgen</h3>
                            <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
                                <input type="text" id="new-category-name" class="flex-grow ${getInputClasses()}" placeholder="Name der neuen Kategorie" value="${newCategoryName}" ${loading ? 'disabled' : ''}>
                                <button id="add-category-btn" class="w-full ${getButtonClasses(colors.tailwind.bgTeal, colors.tailwind.hoverBgCaribbeanCurrent)}" ${loading ? 'disabled' : ''}>
                                    ${loading ? 'Hinzuf√ºgen...' : 'Hinzuf√ºgen'}
                                </button>
                            </div>
                        </div>

                        <div class="${getInnerCardClasses()}">
                            <h3 class="${getSubtitleClasses()}">Deine Kategorien</h3>
                            ${categories.length === 0 ? `<p class="${getItalicTextClasses()}">Noch keine Kategorien vorhanden. F√ºge eine hinzu!</p>` : `
                                <ul class="space-y-3">
                                    ${categories.map(cat => `
                                        <li class="${getListItemClasses()}">
                                            <span class="text-lg font-medium">${cat.name}</span>
                                            <button data-id="${cat.id}" class="${colors.tailwind.bgRed600} ${colors.tailwind.hoverBgRed700} text-white font-bold py-2 px-4 rounded-lg text-sm focus:outline-none focus:shadow-outline transition-all duration-200 transform hover:scale-105" ${loading ? 'disabled' : ''}>
                                                ${loading ? 'L√∂sche...' : 'L√∂schen'}
                                            </button>
                                        </li>
                                    `).join('')}
                                </ul>
                            `}
                        </div>
                    </div>
                `;

                const newCategoryNameInput = document.getElementById('new-category-name');
                if (newCategoryNameInput) newCategoryNameInput.oninput = (e) => { newCategoryName = e.target.value; };

                const addCategoryBtn = document.getElementById('add-category-btn');
                if (addCategoryBtn) addCategoryBtn.onclick = handleAddCategory;

                document.querySelectorAll('.delete-category-btn').forEach(button => {
                    button.onclick = (e) => handleDeleteCategory(e.target.dataset.id);
                });
            };

            const handleAddCategory = async () => {
                if (newCategoryName.trim() === '') {
                    errorMessage = "Der Kategoriename darf nicht leer sein.";
                    updateCategoriesUI(); return;
                }
                loading = true;
                errorMessage = '';
                updateCategoriesUI();
                try {
                    await addDoc(categoriesCollectionRef, {
                        name: newCategoryName.trim(),
                        createdAt: new Date(),
                        userId: currentUserId
                    });
                    newCategoryName = '';
                } catch (error) {
                    console.error("Fehler beim Hinzuf√ºgen der Kategorie:", error);
                    errorMessage = "Fehler beim Hinzuf√ºgen der Kategorie.";
                } finally {
                    loading = false;
                    updateCategoriesUI();
                }
            };

            const handleDeleteCategory = async (categoryId) => {
                loading = true;
                errorMessage = '';
                updateCategoriesUI();
                try {
                    const categoryDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/categories`, categoryId);
                    await deleteDoc(categoryDocRef);
                } catch (error) {
                    console.error("Fehler beim L√∂schen der Kategorie:", error);
                    errorMessage = "Fehler beim L√∂schen der Kategorie.";
                } finally {
                    loading = false;
                    updateCategoriesUI();
                }
            };

            onSnapshot(query(categoriesCollectionRef), (snapshot) => {
                categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                currentCategories = categories;
                updateCategoriesUI();
            }, (error) => {
                console.error("Fehler beim Abrufen der Kategorien:", error);
                errorMessage = "Fehler beim Laden der Kategorien.";
                updateCategoriesUI();
            });

            updateCategoriesUI();
        }

        // --- Einstellungen-Seite (Wiederkehrende Transaktionen & Dashboard-Einstellungen) ---
        async function renderSettingsPage() {
            let recurringTransactions = [];
            let newRecurringName = '';
            let newRecurringAmount = '';
            let newRecurringType = 'expense';
            let newRecurringCategoryId = currentCategories.length > 0 ? currentCategories[0].id : '';
            let newRecurringDay = '';
            let newFrequency = 'monthly';
            let errorMessage = '';
            let loading = false;

            const recurringTransactionsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/recurringTransactions`);

            const updateSettingsUI = () => {
                mainContent.innerHTML = `
                    <div class="${getCardClasses()} max-w-3xl mx-auto">
                        <h2 class="${getTitleClasses()}">Einstellungen</h2>

                        ${errorMessage ? `<div class="bg-red-100 border border-red-400 ${colors.tailwind.textRed700} px-4 py-3 rounded-md relative mb-4" role="alert">
                            <strong class="font-bold">Fehler!</strong>
                            <span class="block sm:inline"> ${errorMessage}</span>
                        </div>` : ''}

                        <!-- Dashboard-Einstellungen -->
                        <div class="${getInnerCardClasses()}">
                            <h3 class="${getSubtitleClasses()}">Dashboard-Einstellungen verwalten</h3>
                            <p class="mb-4 text-sm sm:text-base text-gray-700">W√§hle die Abschnitte, die auf dem Dashboard angezeigt werden sollen:</p>
                            <div class="flex flex-col space-y-3 mb-6 text-left">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="toggle-add-transaction" class="form-checkbox h-5 w-5 text-[#177E89] rounded" ${dashboardSettings.showAddTransaction ? 'checked' : ''}>
                                    <span class="ml-2 text-gray-700">Neue Transaktion hinzuf√ºgen</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="toggle-upcoming-payments" class="form-checkbox h-5 w-5 text-[#177E89] rounded" ${dashboardSettings.showUpcomingPayments ? 'checked' : ''}>
                                    <span class="ml-2 text-gray-700">Bevorstehende wiederkehrende Zahlungen</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="toggle-top-expenses" class="form-checkbox h-5 w-5 text-[#177E89] rounded" ${dashboardSettings.showTopExpenses ? 'checked' : ''}>
                                    <span class="ml-2 text-gray-700">Top 5 gr√∂sste Ausgaben</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="toggle-expense-trend" class="form-checkbox h-5 w-5 text-[#177E89] rounded" ${dashboardSettings.showExpenseTrend ? 'checked' : ''}>
                                    <span class="ml-2 text-gray-700">Ausgaben-Trend</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="toggle-recent-transactions" class="form-checkbox h-5 w-5 text-[#177E89] rounded" ${dashboardSettings.showRecentTransactions ? 'checked' : ''}>
                                    <span class="ml-2 text-gray-700">Letzte Transaktionen</span>
                                </label>
                            </div>
                            <button id="save-dashboard-settings-btn" class="w-full ${getButtonClasses(colors.tailwind.bgTeal, colors.tailwind.hoverBgCaribbeanCurrent)}" ${loading ? 'disabled' : ''}>
                                ${loading ? 'Speichere...' : 'Einstellungen speichern'}
                            </button>
                        </div>

                        <!-- Wiederkehrende Transaktionen -->
                        <div class="${getInnerCardClasses()}">
                            <h3 class="${getSubtitleClasses()}">Neue wiederkehrende Transaktion hinzuf√ºgen</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="${getLabelClasses()}" for="recurringName">Name</label>
                                    <input type="text" id="recurringName" class="${getInputClasses()}" placeholder="z.B. Handy Abo" value="${newRecurringName}" ${loading ? 'disabled' : ''}>
                                </div>
                                <div>
                                    <label class="${getLabelClasses()}" for="recurringAmount">Betrag (CHF)</label>
                                    <input type="number" id="recurringAmount" class="${getInputClasses()}" placeholder="z.B. 49.90" value="${newRecurringAmount}" ${loading ? 'disabled' : ''}>
                                </div>
                                <div>
                                    <label class="${getLabelClasses()}" for="recurringType">Typ</label>
                                    <select id="recurringType" class="${getInputClasses()}" ${loading ? 'disabled' : ''}>
                                        <option value="expense" ${newRecurringType === 'expense' ? 'selected' : ''}>Ausgabe</option>
                                        <option value="income" ${newRecurringType === 'income' ? 'selected' : ''}>Einnahme</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="${getLabelClasses()}" for="recurringCategory">Kategorie</label>
                                    <select id="recurringCategory" class="${getInputClasses()}" ${loading || currentCategories.length === 0 ? 'disabled' : ''}>
                                        ${currentCategories.length === 0 ? `<option value="">Keine Kategorien verf√ºgbar</option>` :
                                            currentCategories.map(cat => `<option value="${cat.id}" ${newRecurringCategoryId === cat.id ? 'selected' : ''}>${cat.name}</option>`).join('')
                                        }
                                    </select>
                                </div>
                                <div>
                                    <label class="${getLabelClasses()}" for="frequency">H√§ufigkeit</label>
                                    <select id="frequency" class="${getInputClasses()}" ${loading ? 'disabled' : ''}>
                                        <option value="monthly" ${newFrequency === 'monthly' ? 'selected' : ''}>Monatlich</option>
                                        <option value="weekly" ${newFrequency === 'weekly' ? 'selected' : ''}>W√∂chentlich</option>
                                        <option value="yearly" ${newFrequency === 'yearly' ? 'selected' : ''}>J√§hrlich</option>
                                    </select>
                                </div>
                                ${newRecurringType === 'income' && newFrequency === 'monthly' ? `
                                    <div>
                                        <label class="${getLabelClasses()}" for="recurringDay">Monatlicher Zahltag (Tag des Monats)</label>
                                        <input type="number" id="recurringDay" class="${getInputClasses()}" placeholder="z.B. 25" min="1" max="31" value="${newRecurringDay}" ${loading ? 'disabled' : ''}>
                                    </div>
                                ` : ''}
                            </div>
                            <button id="add-recurring-btn" class="w-full ${getButtonClasses(colors.tailwind.bgTeal, colors.tailwind.hoverBgCaribbeanCurrent)}" ${loading || (currentCategories.length === 0 && newRecurringType !== 'income') ? 'disabled' : ''}>
                                ${loading ? 'Hinzuf√ºgen...' : 'Wiederkehrende Transaktion hinzuf√ºgen'}
                            </button>
                            ${currentCategories.length === 0 ? `<p class="text-sm text-red-500 mt-2 text-center">Bitte f√ºge zuerst Kategorien im Reiter "Kategorien" hinzu, um wiederkehrende Transaktionen zu erfassen.</p>` : ''}
                        </div>

                        <div class="${getInnerCardClasses()}">
                            <h3 class="${getSubtitleClasses()}">Deine wiederkehrenden Transaktionen</h3>
                            ${recurringTransactions.length === 0 ? `<p class="${getItalicTextClasses()}">Noch keine wiederkehrenden Transaktionen vorhanden.</p>` : `
                                <ul class="space-y-3">
                                    ${recurringTransactions.map(t => `
                                        <li class="${getListItemClasses()}">
                                            <div>
                                                <span class="${t.type === 'income' ? getIncomeTextClasses() : getExpenseTextClasses()}">
                                                    ${t.name}: ${t.type === 'income' ? '+' : '-'} ${t.amount.toFixed(2)} CHF
                                                </span>
                                                <p class="${getXSmallTextClasses()}">
                                                    Kategorie: ${currentCategories.find(cat => cat.id === t.categoryId)?.name || 'Unbekannt'} | H√§ufigkeit: ${
                                                        t.frequency === 'monthly' ? 'Monatlich' :
                                                        t.frequency === 'weekly' ? 'W√∂chentlich' :
                                                        t.frequency === 'yearly' ? 'J√§hrlich' : 'Unbekannt'
                                                    }
                                                    ${t.recurringDay ? ` | Zahltag: Tag ${t.recurringDay} des Monats` : ''}
                                                </p>
                                            </div>
                                            <button data-id="${t.id}" class="${colors.tailwind.bgRed600} ${colors.tailwind.hoverBgRed700} text-white font-bold py-2 px-4 rounded-lg text-sm focus:outline-none focus:shadow-outline transition-all duration-200 transform hover:scale-105" ${loading ? 'disabled' : ''}>
                                                ${loading ? 'L√∂sche...' : 'L√∂schen'}
                                            </button>
                                        </li>
                                    `).join('')}
                                </ul>
                            `}
                        </div>
                    </div>
                `;

                // Event Listener neu zuweisen f√ºr Dashboard-Einstellungen
                const saveDashboardSettingsBtn = document.getElementById('save-dashboard-settings-btn');
                if (saveDashboardSettingsBtn) {
                    saveDashboardSettingsBtn.onclick = handleSaveDashboardSettings;
                }
                // Checkboxen m√ºssen keine direkten onchange-Listener haben, da der Speichern-Button ihren Zustand liest.
                // Die `checked`-Attribute werden durch `dashboardSettings` korrekt gesetzt.


                // Event Listener neu zuweisen f√ºr wiederkehrende Transaktionen
                const recurringNameInput = document.getElementById('recurringName');
                if (recurringNameInput) recurringNameInput.oninput = (e) => { newRecurringName = e.target.value; };
                const recurringAmountInput = document.getElementById('recurringAmount');
                if (recurringAmountInput) recurringAmountInput.oninput = (e) => { newRecurringAmount = e.target.value; };
                const recurringTypeSelect = document.getElementById('recurringType');
                if (recurringTypeSelect) recurringTypeSelect.onchange = (e) => {
                    newRecurringType = e.target.value;
                    updateSettingsUI();
                };
                const recurringCategorySelect = document.getElementById('recurringCategory');
                if (recurringCategorySelect) recurringCategorySelect.onchange = (e) => { newRecurringCategoryId = e.target.value; };
                const frequencySelect = document.getElementById('frequency');
                if (frequencySelect) frequencySelect.onchange = (e) => {
                    newFrequency = e.target.value;
                    updateSettingsUI();
                };
                const recurringDayInput = document.getElementById('recurringDay');
                if (recurringDayInput) recurringDayInput.oninput = (e) => { newRecurringDay = e.target.value; };

                const addRecurringBtn = document.getElementById('add-recurring-btn');
                if (addRecurringBtn) addRecurringBtn.onclick = handleAddRecurringTransaction;

                document.querySelectorAll('.delete-recurring-btn').forEach(button => {
                    button.onclick = (e) => handleDeleteRecurringTransaction(e.target.dataset.id);
                });
            };

            const handleAddRecurringTransaction = async () => {
                errorMessage = '';
                if (newRecurringName.trim() === '') {
                    errorMessage = "Bitte einen Namen f√ºr die wiederkehrende Transaktion eingeben.";
                    updateSettingsUI(); return;
                }
                if (newRecurringAmount === '' || isNaN(parseFloat(newRecurringAmount)) || parseFloat(newRecurringAmount) <= 0) {
                    errorMessage = "Bitte einen g√ºltigen Betrag eingeben.";
                    updateSettingsUI(); return;
                }
                if (newRecurringCategoryId === '' && currentCategories.length === 0) {
                    errorMessage = "Bitte f√ºge zuerst Kategorien hinzu, bevor du Transaktionen erfasst.";
                    updateSettingsUI(); return;
                }
                const day = parseInt(newRecurringDay, 10);
                if (newRecurringType === 'income' && newFrequency === 'monthly' && (isNaN(day) || day < 1 || day > 31)) {
                    errorMessage = "Bitte einen g√ºltigen Tag (1-31) f√ºr monatliche wiederkehrende Einnahmen angeben.";
                    updateSettingsUI(); return;
                }

                loading = true;
                updateSettingsUI();
                try {
                    await addDoc(recurringTransactionsCollectionRef, {
                        name: newRecurringName.trim(),
                        amount: parseFloat(newRecurringAmount),
                        type: newRecurringType,
                        categoryId: newRecurringCategoryId,
                        frequency: newFrequency,
                        recurringDay: newRecurringType === 'income' && newFrequency === 'monthly' ? day : null,
                        createdAt: serverTimestamp(),
                        userId: currentUserId
                    });
                    newRecurringName = '';
                    newRecurringAmount = '';
                    newRecurringDay = '';
                } catch (error) {
                    console.error("Fehler beim Hinzuf√ºgen der wiederkehrenden Transaktion:", error);
                    errorMessage = "Fehler beim Hinzuf√ºgen der wiederkehrenden Transaktion.";
                } finally {
                    loading = false;
                    updateSettingsUI();
                }
            };

            const handleDeleteRecurringTransaction = async (transactionId) => {
                loading = true;
                errorMessage = '';
                updateSettingsUI();
                try {
                    const transactionDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/recurringTransactions`, transactionId);
                    await deleteDoc(transactionDocRef);
                } catch (error) {
                    console.error("Fehler beim L√∂schen der wiederkehrenden Transaktion:", error);
                    errorMessage = "Fehler beim L√∂schen der wiederkehrenden Transaktion.";
                } finally {
                    loading = false;
                    updateSettingsUI();
                }
            };

            onSnapshot(query(recurringTransactionsCollectionRef, orderBy('createdAt', 'desc')), (snapshot) => {
                recurringTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateSettingsUI();
            }, (error) => {
                console.error("Fehler beim Abrufen der wiederkehrenden Transaktionen:", error);
                errorMessage = "Fehler beim Laden der wiederkehrenden Transaktionen.";
                updateSettingsUI();
            });

            onSnapshot(query(collection(db, `artifacts/${appId}/users/${currentUserId}/categories`)), (snapshot) => {
                currentCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (newRecurringCategoryId === '' && currentCategories.length > 0) {
                    newRecurringCategoryId = currentCategories[0].id;
                }
                updateSettingsUI();
            }, (error) => {
                console.error("Fehler beim Abrufen der Kategorien f√ºr Einstellungen:", error);
                errorMessage = "Fehler beim Laden der Kategorien.";
                updateSettingsUI();
            });

            updateSettingsUI();
        }

        // --- Budgetgrenzen-Seite ---
        async function renderBudgetLimitsPage() {
            let budgetLimits = [];
            let newLimitAmount = '';
            let selectedCategoryId = currentCategories.length > 0 ? currentCategories[0].id : '';
            let errorMessage = '';
            let loading = false;

            const budgetLimitsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/budgetLimits`);

            const updateBudgetLimitsUI = () => {
                mainContent.innerHTML = `
                    <div class="${getCardClasses()} max-w-3xl mx-auto">
                        <h2 class="${getTitleClasses()}">Budgetgrenzen verwalten</h2>

                        ${errorMessage ? `<div class="bg-red-100 border border-red-400 ${colors.tailwind.textRed700} px-4 py-3 rounded-md relative mb-4" role="alert">
                            <strong class="font-bold">Fehler!</strong>
                            <span class="block sm:inline"> ${errorMessage}</span>
                        </div>` : ''}

                        <div class="${getInnerCardClasses()}">
                            <h3 class="${getSubtitleClasses()}">Budgetgrenze festlegen</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="${getLabelClasses()}" for="limitCategory">Kategorie</label>
                                    <select id="limitCategory" class="${getInputClasses()}" ${loading || currentCategories.length === 0 ? 'disabled' : ''}>
                                        ${currentCategories.length === 0 ? `<option value="">Keine Kategorien verf√ºgbar</option>` : `
                                            <option value="">Kategorie ausw√§hlen</option>
                                            ${currentCategories.map(cat => `<option value="${cat.id}" ${selectedCategoryId === cat.id ? 'selected' : ''}>${cat.name}</option>`).join('')}
                                        `}
                                    </select>
                                </div>
                                <div>
                                    <label class="${getLabelClasses()}" for="limitAmount">Grenze (CHF)</label>
                                    <input type="number" id="limitAmount" class="${getInputClasses()}" placeholder="z.B. 200.00" value="${newLimitAmount}" ${loading ? 'disabled' : ''}>
                                </div>
                            </div>
                            <button id="set-limit-btn" class="w-full ${getButtonClasses(colors.tailwind.bgTeal, colors.tailwind.hoverBgCaribbeanCurrent)}" ${loading || currentCategories.length === 0 || selectedCategoryId === '' ? 'disabled' : ''}>
                                ${loading ? 'Speichere...' : 'Grenze festlegen'}
                            </button>
                            ${currentCategories.length === 0 ? `<p class="text-sm text-red-500 mt-2 text-center">Bitte f√ºge zuerst Kategorien im Reiter "Kategorien" hinzu, um Budgetgrenzen festzulegen.</p>` : ''}
                        </div>

                        <div class="${getInnerCardClasses()}">
                            <h3 class="${getSubtitleClasses()}">Deine Budgetgrenzen</h3>
                            ${budgetLimits.length === 0 ? `<p class="${getItalicTextClasses()}">Noch keine Budgetgrenzen festgelegt.</p>` : `
                                <ul class="space-y-3">
                                    ${budgetLimits.map(limit => `
                                        <li class="${getListItemClasses()}">
                                            <div>
                                                <span class="text-lg font-medium">${currentCategories.find(cat => cat.id === limit.categoryId)?.name || 'Unbekannt'}</span>
                                                <p class="${getSmallTextClasses()}">Grenze: ${limit.amount.toFixed(2)} CHF</p>
                                            </div>
                                            <button data-id="${limit.id}" class="${colors.tailwind.bgRed600} ${colors.tailwind.hoverBgRed700} text-white font-bold py-2 px-4 rounded-lg text-sm focus:outline-none focus:shadow-outline transition-all duration-200 transform hover:scale-105" ${loading ? 'disabled' : ''}>
                                                ${loading ? 'L√∂sche...' : 'L√∂schen'}
                                            </button>
                                        </li>
                                    `).join('')}
                                </ul>
                            `}
                        </div>
                    </div>
                `;

                const limitCategorySelect = document.getElementById('limitCategory');
                if (limitCategorySelect) limitCategorySelect.onchange = (e) => { selectedCategoryId = e.target.value; };
                const limitAmountInput = document.getElementById('limitAmount');
                if (limitAmountInput) limitAmountInput.oninput = (e) => { newLimitAmount = e.target.value; };

                const setLimitBtn = document.getElementById('set-limit-btn');
                if (setLimitBtn) setLimitBtn.onclick = handleSetBudgetLimit;

                document.querySelectorAll('.delete-limit-btn').forEach(button => {
                    button.onclick = (e) => handleDeleteBudgetLimit(e.target.dataset.id);
                });
            };

            const handleSetBudgetLimit = async () => {
                errorMessage = '';
                if (selectedCategoryId === '') {
                    errorMessage = "Bitte eine Kategorie ausw√§hlen.";
                    updateBudgetLimitsUI(); return;
                }
                if (newLimitAmount === '' || isNaN(parseFloat(newLimitAmount)) || parseFloat(newLimitAmount) <= 0) {
                    errorMessage = "Bitte einen g√ºltigen Betrag f√ºr die Grenze eingeben.";
                    updateBudgetLimitsUI(); return;
                }

                loading = true;
                updateBudgetLimitsUI();
                try {
                    const existingLimit = budgetLimits.find(limit => limit.categoryId === selectedCategoryId);
                    const limitRef = existingLimit
                        ? doc(db, `artifacts/${appId}/users/${currentUserId}/budgetLimits`, existingLimit.id)
                        : doc(budgetLimitsCollectionRef);

                    await setDoc(limitRef, {
                        categoryId: selectedCategoryId,
                        amount: parseFloat(newLimitAmount),
                        userId: currentUserId,
                        updatedAt: serverTimestamp(),
                    }, { merge: true });

                    newLimitAmount = '';
                } catch (error) {
                    console.error("Fehler beim Setzen der Budgetgrenze:", error);
                    errorMessage = "Fehler beim Setzen der Budgetgrenze.";
                } finally {
                    loading = false;
                    updateBudgetLimitsUI();
                }
            };

            const handleDeleteBudgetLimit = async (limitId) => {
                loading = true;
                errorMessage = '';
                updateBudgetLimitsUI();
                try {
                    const limitDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/budgetLimits`, limitId);
                    await deleteDoc(limitDocRef);
                } catch (error) {
                    console.error("Fehler beim L√∂schen der Budgetgrenze:", error);
                    errorMessage = "Fehler beim L√∂schen der Budgetgrenze.";
                } finally {
                    loading = false;
                    updateBudgetLimitsUI();
                }
            };

            onSnapshot(query(budgetLimitsCollectionRef), (snapshot) => {
                budgetLimits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateBudgetLimitsUI();
            }, (error) => {
                console.error("Fehler beim Abrufen der Budgetgrenzen:", error);
                errorMessage = "Fehler beim Laden der Budgetgrenzen.";
                updateBudgetLimitsUI();
            });

            onSnapshot(query(collection(db, `artifacts/${appId}/users/${currentUserId}/categories`)), (snapshot) => {
                currentCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (selectedCategoryId === '' && currentCategories.length > 0) {
                    selectedCategoryId = currentCategories[0].id;
                }
                updateBudgetLimitsUI();
            }, (error) => {
                console.error("Fehler beim Abrufen der Kategorien f√ºr Budgetgrenzen:", error);
                errorMessage = "Fehler beim Laden der Kategorien.";
                updateBudgetLimitsUI();
            });

            updateBudgetLimitsUI();
        }

        // --- Sparziele-Seite ---
        async function renderSavingsGoalsPage() {
            let savingsGoals = [];
            let newGoalName = '';
            let newGoalTargetAmount = '';
            let newGoalTargetDate = '';
            let errorMessage = '';
            let modalErrorMessage = '';
            let loading = false;
            let showAddFundsModal = false;
            let selectedGoalForFunds = null;
            let fundsToAdd = '';
            let currentBalance = 0;

            const savingsGoalsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/savingsGoals`);
            const transactionsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/transactions`);

            const updateSavingsGoalsUI = () => {
                mainContent.innerHTML = `
                    <div class="${getCardClasses()} max-w-3xl mx-auto">
                        <h2 class="${getTitleClasses()}">Deine Sparziele</h2>

                        ${errorMessage ? `<div class="bg-red-100 border border-red-400 ${colors.tailwind.textRed700} px-4 py-3 rounded-md relative mb-4" role="alert">
                            <strong class="font-bold">Fehler!</strong>
                            <span class="block sm:inline"> ${errorMessage}</span>
                        </div>` : ''}

                        <div class="${getInnerCardClasses()}">
                            <h3 class="${getSubtitleClasses()}">Neues Sparziel hinzuf√ºgen</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="${getLabelClasses()}" for="goalName">Name des Ziels</label>
                                    <input type="text" id="goalName" class="${getInputClasses()}" placeholder="z.B. Neues Handy" value="${newGoalName}" ${loading ? 'disabled' : ''}>
                                </div>
                                <div>
                                    <label class="${getLabelClasses()}" for="goalTargetAmount">Zielbetrag (CHF)</label>
                                    <input type="number" id="goalTargetAmount" class="${getInputClasses()}" placeholder="z.B. 800.00" value="${newGoalTargetAmount}" ${loading ? 'disabled' : ''}>
                                </div>
                                <div>
                                    <label class="${getLabelClasses()}" for="goalTargetDate">Zieldatum</label>
                                    <input type="date" id="goalTargetDate" class="${getInputClasses()}" value="${newGoalTargetDate}" ${loading ? 'disabled' : ''}>
                                </div>
                            </div>
                            <button id="add-goal-btn" class="w-full ${getButtonClasses(colors.tailwind.bgTeal, colors.tailwind.hoverBgCaribbeanCurrent)}" ${loading ? 'disabled' : ''}>
                                ${loading ? 'Hinzuf√ºgen...' : 'Sparziel hinzuf√ºgen'}
                            </button>
                        </div>

                        <div class="${getInnerCardClasses()}">
                            <h3 class="${getSubtitleClasses()}">Aktuelle Sparziele</h3>
                            <p class="text-md font-semibold mb-4 text-gray-800">Verf√ºgbarer Saldo: ${currentBalance.toFixed(2)} CHF</p>
                            ${savingsGoals.length === 0 ? `<p class="${getItalicTextClasses()}">Noch keine Sparziele festgelegt.</p>` : `
                                <ul class="space-y-4">
                                    ${savingsGoals.map(goal => {
                                        const progress = (goal.currentAmount / goal.targetAmount) * 100;
                                        const progressBarColor = progress >= 100 ? 'bg-green-500' : 'bg-blue-500';
                                        const textColor = 'text-gray-900';
                                        const subTextColor = 'text-gray-700';
                                        const goalStatus = goal.currentAmount >= goal.targetAmount ? 'Erreicht üéâ' : 'In Bearbeitung';
                                        const targetDateFormatted = goal.targetDate ? new Date(goal.targetDate).toLocaleDateString() : 'N/A';

                                        return `
                                            <li class="${getListItemClasses()} flex-col items-start space-y-2">
                                                <div class="w-full flex justify-between items-center">
                                                    <span class="text-lg font-medium ${textColor}">${goal.name}</span>
                                                    <span class="text-base font-semibold ${goal.currentAmount >= goal.targetAmount ? 'text-green-600' : 'text-blue-600'}">${goal.currentAmount.toFixed(2)} CHF / ${goal.targetAmount.toFixed(2)} CHF</span>
                                                </div>
                                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                                    <div class="${progressBarColor} h-2.5 rounded-full" style="width: ${Math.min(100, progress)}%;"></div>
                                                </div>
                                                <div class="w-full flex justify-between text-sm ${subTextColor}">
                                                    <span>Fortschritt: ${progress.toFixed(1)}%</span>
                                                    <span>Status: ${goalStatus}</span>
                                                </div>
                                                <div class="w-full flex justify-between text-xs ${getXSmallTextClasses()}">
                                                    <span>Zieldatum: ${targetDateFormatted}</span>
                                                </div>
                                                <div class="w-full flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-2 mt-2">
                                                    <button data-id="${goal.id}" class="add-funds-btn ${getButtonClasses(colors.tailwind.bgMossGreen, colors.tailwind.hoverBgCaribbeanCurrent)} text-sm py-1.5 px-3" ${loading || goal.currentAmount >= goal.targetAmount ? 'disabled' : ''}>
                                                        Geld hinzuf√ºgen
                                                    </button>
                                                    <button data-id="${goal.id}" class="delete-goal-btn ${colors.tailwind.bgRed600} ${colors.tailwind.hoverBgRed700} text-white font-bold py-1.5 px-3 rounded-lg text-sm focus:outline-none focus:shadow-outline transition-all duration-200 transform hover:scale-105" ${loading ? 'disabled' : ''}>
                                                        L√∂schen
                                                    </button>
                                                </div>
                                            </li>
                                        `;
                                    }).join('')}
                                </ul>
                            `}
                        </div>
                    </div>

                    ${showAddFundsModal ? `
                        <div class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 p-4">
                            <div class="${getCardClasses()} max-w-sm w-full text-center">
                                <h3 class="${getSubtitleClasses()} text-xl sm:text-2xl">Geld zu "${selectedGoalForFunds ? selectedGoalForFunds.name : ''}" hinzuf√ºgen</h3>
                                <p class="mb-4 text-sm sm:text-base text-gray-700">
                                    Aktueller Betrag: ${selectedGoalForFunds ? selectedGoalForFunds.currentAmount.toFixed(2) : '0.00'} CHF
                                </p>
                                ${modalErrorMessage ? `<div class="bg-red-100 border border-red-400 ${colors.tailwind.textRed700} px-4 py-3 rounded-md relative mb-4" role="alert">
                                    <strong class="font-bold">Fehler!</strong>
                                    <span class="block sm:inline"> ${modalErrorMessage}</span>
                                </div>` : ''}
                                <div class="mb-6">
                                    <label class="${getLabelClasses()}" for="fundsToAddInput">Betrag hinzuf√ºgen (CHF)</label>
                                    <input type="number" id="fundsToAddInput" class="${getInputClasses()}" placeholder="z.B. 50.00" value="${fundsToAdd}" ${loading ? 'disabled' : ''}>
                                </div>
                                <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                                    <button id="confirm-add-funds-btn" class="${getButtonClasses(colors.tailwind.bgTeal, colors.tailwind.hoverBgCaribbeanCurrent)} text-sm py-2 px-4" ${loading ? 'disabled' : ''}>
                                        Hinzuf√ºgen
                                    </button>
                                    <button id="cancel-add-funds-btn" class="${getButtonClasses('bg-gray-200', 'hover:bg-gray-300')} text-gray-800" ${loading ? 'disabled' : ''}>
                                        Abbrechen
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                `;

                const goalNameInput = document.getElementById('goalName');
                if (goalNameInput) goalNameInput.oninput = (e) => { newGoalName = e.target.value; };
                const goalTargetAmountInput = document.getElementById('goalTargetAmount');
                if (goalTargetAmountInput) goalTargetAmountInput.oninput = (e) => { newGoalTargetAmount = e.target.value; };
                const goalTargetDateInput = document.getElementById('goalTargetDate');
                if (goalTargetDateInput) goalTargetDateInput.oninput = (e) => { newGoalTargetDate = e.target.value; };

                const addGoalBtn = document.getElementById('add-goal-btn');
                if (addGoalBtn) addGoalBtn.onclick = handleAddGoal;

                document.querySelectorAll('.add-funds-btn').forEach(button => {
                    button.onclick = (e) => {
                        const goalId = e.target.dataset.id;
                        selectedGoalForFunds = savingsGoals.find(g => g.id === goalId);
                        fundsToAdd = '';
                        modalErrorMessage = '';
                        showAddFundsModal = true;
                        updateSavingsGoalsUI();
                    };
                });

                document.querySelectorAll('.delete-goal-btn').forEach(button => {
                    button.onclick = (e) => handleDeleteGoal(e.target.dataset.id);
                });

                if (showAddFundsModal) {
                    const fundsToAddInput = document.getElementById('fundsToAddInput');
                    if (fundsToAddInput) fundsToAddInput.oninput = (e) => {
                        fundsToAdd = e.target.value;
                        modalErrorMessage = '';
                        updateSavingsGoalsUI();
                    };

                    const confirmAddFundsBtn = document.getElementById('confirm-add-funds-btn');
                    if (confirmAddFundsBtn) confirmAddFundsBtn.onclick = handleAddFunds;

                    const cancelAddFundsBtn = document.getElementById('cancel-add-funds-btn');
                    if (cancelAddFundsBtn) cancelAddFundsBtn.onclick = () => { showAddFundsModal = false; modalErrorMessage = ''; updateSavingsGoalsUI(); };
                }
            };

            const handleAddGoal = async () => {
                errorMessage = '';
                if (newGoalName.trim() === '') {
                    errorMessage = "Bitte einen Namen f√ºr das Sparziel eingeben.";
                    updateSavingsGoalsUI(); return;
                }
                if (newGoalTargetAmount === '' || isNaN(parseFloat(newGoalTargetAmount)) || parseFloat(newGoalTargetAmount) <= 0) {
                    errorMessage = "Bitte einen g√ºltigen Zielbetrag eingeben.";
                    updateSavingsGoalsUI(); return;
                }

                loading = true;
                updateSavingsGoalsUI();
                try {
                    await addDoc(savingsGoalsCollectionRef, {
                        name: newGoalName.trim(),
                        targetAmount: parseFloat(newGoalTargetAmount),
                        currentAmount: 0,
                        targetDate: newGoalTargetDate || null,
                        createdAt: serverTimestamp(),
                        userId: currentUserId,
                        achieved: false,
                        achievedDate: null,
                        achievedMilestones: []
                    });
                    newGoalName = '';
                    newGoalTargetAmount = '';
                    newGoalTargetDate = '';
                } catch (error) {
                    console.error("Fehler beim Hinzuf√ºgen des Sparziels:", error);
                    errorMessage = "Fehler beim Hinzuf√ºgen des Sparziels.";
                } finally {
                    loading = false;
                    updateSavingsGoalsUI();
                }
            };

            const handleAddFunds = async () => {
                modalErrorMessage = '';
                if (!selectedGoalForFunds) return;
                if (fundsToAdd === '' || isNaN(parseFloat(fundsToAdd)) || parseFloat(fundsToAdd) <= 0) {
                    modalErrorMessage = "Bitte einen g√ºltigen Betrag zum Hinzuf√ºgen eingeben.";
                    updateSavingsGoalsUI(); return;
                }

                const amountToAdd = parseFloat(fundsToAdd);
                if (amountToAdd > currentBalance) {
                    modalErrorMessage = `Du kannst nicht mehr als deinen aktuellen Saldo (${currentBalance.toFixed(2)} CHF) hinzuf√ºgen.`;
                    updateSavingsGoalsUI();
                    return;
                }

                loading = true;
                showAddFundsModal = false;
                updateSavingsGoalsUI();

                try {
                    const newCurrentAmount = selectedGoalForFunds.currentAmount + amountToAdd;
                    const goalDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/savingsGoals`, selectedGoalForFunds.id);

                    let updateData = { currentAmount: newCurrentAmount };
                    let milestonesToUpdate = [...(selectedGoalForFunds.achievedMilestones || [])];
                    let showMilestoneReward = false;
                    let milestoneMessage = '';

                    const progress = (newCurrentAmount / selectedGoalForFunds.targetAmount) * 100;
                    const milestones = [25, 50, 75, 100];

                    for (const milestone of milestones) {
                        if (progress >= milestone && !milestonesToUpdate.includes(milestone)) {
                            milestonesToUpdate.push(milestone);
                            showMilestoneReward = true;
                            if (milestone === 100) {
                                milestoneMessage = `Herzlichen Gl√ºckwunsch! Du hast dein Sparziel "${selectedGoalForFunds.name}" erfolgreich erreicht!`;
                                updateData.achieved = true;
                                updateData.achievedDate = serverTimestamp();
                            } else {
                                milestoneMessage = `Super! Du hast ${milestone}% deines Sparziels "${selectedGoalForFunds.name}" erreicht!`;
                            }
                        }
                    }
                    updateData.achievedMilestones = milestonesToUpdate;

                    await updateDoc(goalDocRef, updateData);

                    if (showMilestoneReward) {
                        rewardMessage.textContent = milestoneMessage;
                        rewardModal.classList.remove('hidden');
                        closeRewardModalBtn.onclick = () => {
                            rewardModal.classList.add('hidden');
                        };
                    }

                    fundsToAdd = '';
                    selectedGoalForFunds = null;
                } catch (error) {
                    console.error("Fehler beim Hinzuf√ºgen von Geld zum Sparziel:", error);
                    modalErrorMessage = "Fehler beim Hinzuf√ºgen von Geld zum Sparziel: " + error.message;
                } finally {
                    loading = false;
                    updateSavingsGoalsUI();
                }
            };

            const handleDeleteGoal = async (goalId) => {
                loading = true;
                errorMessage = '';
                updateSavingsGoalsUI();
                try {
                    const goalDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/savingsGoals`, goalId);
                    await deleteDoc(goalDocRef);
                } catch (error) {
                    console.error("Fehler beim L√∂schen des Sparziels:", error);
                    errorMessage = "Fehler beim L√∂schen des Sparziels.";
                } finally {
                    loading = false;
                    updateSavingsGoalsUI();
                }
            };

            onSnapshot(query(transactionsCollectionRef), (snapshot) => {
                const transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                currentBalance = totalIncome - totalExpense;
                updateSavingsGoalsUI();
            }, (error) => {
                console.error("Fehler beim Abrufen der Transaktionen f√ºr Sparziele:", error);
                errorMessage = "Fehler beim Laden des Saldos.";
                updateSavingsGoalsUI();
            });


            onSnapshot(query(savingsGoalsCollectionRef, orderBy('createdAt', 'desc')), (snapshot) => {
                savingsGoals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateSavingsGoalsUI();
            }, (error) => {
                console.error("Fehler beim Abrufen der Sparziele:", error);
                errorMessage = "Fehler beim Laden der Sparziele.";
                updateSavingsGoalsUI();
            });

            updateSavingsGoalsUI();
        }

        // --- NEUE SEITE: Rechnungen analysieren ---
        async function renderInvoiceAnalysisPage() {
            let selectedImageBase64 = null;
            let imageMimeType = null;
            let analysisResult = null;
            let analysisLoading = false;
            let analysisError = '';

            let transactionAmount = '';
            let transactionDescription = '';
            let transactionDate = '';
            let transactionCategoryId = currentCategories.length > 0 ? currentCategories[0].id : '';
            let transactionType = 'expense';

            const transactionsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/transactions`);
            const categoriesCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/categories`);

            const updateInvoiceAnalysisUI = () => {
                mainContent.innerHTML = `
                    <div class="${getCardClasses()} max-w-3xl mx-auto">
                        <h2 class="${getTitleClasses()}">Rechnungen analysieren</h2>

                        ${analysisError ? `<div class="bg-red-100 border border-red-400 ${colors.tailwind.textRed700} px-4 py-3 rounded-md relative mb-4" role="alert">
                            <strong class="font-bold">Fehler!</strong>
                            <span class="block sm:inline"> ${analysisError}</span>
                        </div>` : ''}

                        <div class="${getInnerCardClasses()}">
                            <h3 class="${getSubtitleClasses()}">Rechnung hochladen</h3>
                            <input type="file" id="invoice-image-input" accept="image/png, image/jpeg" class="${getInputClasses()} mb-4">
                            <div id="image-preview" class="mb-4 flex justify-center items-center h-48 bg-gray-100 border border-gray-300 rounded-lg overflow-hidden">
                                ${selectedImageBase64 ? `<img src="${selectedImageBase64}" alt="Rechnungsvorschau" class="max-w-full max-h-full object-contain">` : `<span class="text-gray-500">Kein Bild ausgew√§hlt</span>`}
                            </div>
                            <button id="analyze-invoice-btn" class="w-full ${getButtonClasses(colors.tailwind.bgTeal, colors.tailwind.hoverBgCaribbeanCurrent)}" ${!selectedImageBase64 || analysisLoading ? 'disabled' : ''}>
                                ${analysisLoading ? 'Analysiere...' : 'Rechnung analysieren'}
                            </button>
                        </div>

                        ${analysisResult ? `
                            <div class="${getInnerCardClasses()}">
                                <h3 class="${getSubtitleClasses()}">Analysierte Daten</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="${getLabelClasses()}" for="analyzedAmount">Betrag (CHF)</label>
                                        <input type="number" id="analyzedAmount" class="${getInputClasses()}" value="${transactionAmount}" placeholder="0.00">
                                    </div>
                                    <div>
                                        <label class="${getLabelClasses()}" for="analyzedDescription">Beschreibung</label>
                                        <input type="text" id="analyzedDescription" class="${getInputClasses()}" value="${transactionDescription}" placeholder="Beschreibung">
                                    </div>
                                    <div>
                                        <label class="${getLabelClasses()}" for="analyzedDate">Datum</label>
                                        <input type="date" id="analyzedDate" class="${getInputClasses()}" value="${transactionDate}">
                                    </div>
                                    <div>
                                        <label class="${getLabelClasses()}" for="analyzedCategory">Kategorie</label>
                                        <select id="analyzedCategory" class="${getInputClasses()}">
                                            ${currentCategories.length === 0 ? `<option value="">Keine Kategorien verf√ºgbar</option>` :
                                                currentCategories.map(cat => `<option value="${cat.id}" ${transactionCategoryId === cat.id ? 'selected' : ''}>${cat.name}</option>`).join('')
                                            }
                                        </select>
                                    </div>
                                </div>
                                <button id="save-analyzed-transaction-btn" class="w-full ${getButtonClasses(colors.tailwind.bgCaribbeanCurrent, colors.tailwind.hoverBgTeal)}">
                                    Transaktion speichern
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;

                const invoiceImageInput = document.getElementById('invoice-image-input');
                if (invoiceImageInput) {
                    invoiceImageInput.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                selectedImageBase64 = event.target.result;
                                imageMimeType = file.type;
                                analysisResult = null;
                                analysisError = '';
                                updateInvoiceAnalysisUI();
                            };
                            reader.readAsDataURL(file);
                        } else {
                            selectedImageBase64 = null;
                            imageMimeType = null;
                            analysisResult = null;
                            analysisError = '';
                            updateInvoiceAnalysisUI();
                        }
                    };
                }

                const analyzeInvoiceBtn = document.getElementById('analyze-invoice-btn');
                if (analyzeInvoiceBtn) analyzeInvoiceBtn.onclick = analyzeInvoice;

                if (analysisResult) {
                    const analyzedAmountInput = document.getElementById('analyzedAmount');
                    if (analyzedAmountInput) analyzedAmountInput.oninput = (e) => { transactionAmount = e.target.value; };
                    const analyzedDescriptionInput = document.getElementById('analyzedDescription');
                    if (analyzedDescriptionInput) analyzedDescriptionInput.oninput = (e) => { transactionDescription = e.target.value; };
                    const analyzedDateInput = document.getElementById('analyzedDate');
                    if (analyzedDateInput) analyzedDateInput.oninput = (e) => { transactionDate = e.target.value; };
                    const analyzedCategorySelect = document.getElementById('analyzedCategory');
                    if (analyzedCategorySelect) analyzedCategorySelect.onchange = (e) => { transactionCategoryId = e.target.value; };

                    const saveAnalyzedTransactionBtn = document.getElementById('save-analyzed-transaction-btn');
                    if (saveAnalyzedTransactionBtn) saveAnalyzedTransactionBtn.onclick = saveAnalyzedTransaction;
                }
            };

            const analyzeInvoice = async () => {
                if (!selectedImageBase64) {
                    analysisError = "Bitte w√§hlen Sie zuerst ein Rechnungsbild aus.";
                    updateInvoiceAnalysisUI();
                    return;
                }

                analysisLoading = true;
                analysisError = '';
                analysisResult = null;
                updateInvoiceAnalysisUI();

                try {
                    const base64ImageData = selectedImageBase64.split(',')[1];

                    const prompt = `
                        Analysiere diese Rechnung und extrahiere die folgenden Informationen im JSON-Format:
                        {
                            "amount": <Gesamtbetrag als Zahl, z.B. 123.45>,
                            "description": "<Kurze Beschreibung der Rechnung, z.B. 'Einkauf bei Migros'>",
                            "date": "<Datum der Rechnung im FormatYYYY-MM-DD>",
                            "suggestedCategory": "<Vorgeschlagene Kategorie als String, z.B. 'Lebensmittel', 'Transport', 'Freizeit'>",
                            "vendor": "<Name des Anbieters/Gesch√§fts, falls erkennbar>"
                        }
                        Stelle sicher, dass der Betrag immer ein numerischer Wert ist. Wenn ein Feld nicht gefunden wird, setze es auf null oder einen leeren String.
                    `;

                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = {
                        contents: [
                            {
                                role: "user",
                                parts: [
                                    { text: prompt },
                                    {
                                        inlineData: {
                                            mimeType: imageMimeType,
                                            data: base64ImageData
                                        }
                                    }
                                ]
                            }
                        ],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    "amount": { "type": "NUMBER" },
                                    "description": { "type": "STRING" },
                                    "date": { "type": "STRING" },
                                    "suggestedCategory": { "type": "STRING" },
                                    "vendor": { "type": "STRING" }
                                }
                            }
                        }
                    };

                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const jsonString = result.candidates[0].content.parts[0].text;
                        analysisResult = JSON.parse(jsonString);

                        transactionAmount = analysisResult.amount ? parseFloat(analysisResult.amount).toFixed(2) : '';
                        transactionDescription = analysisResult.description || '';
                        transactionDate = analysisResult.date || '';

                        const matchedCategory = currentCategories.find(cat =>
                            analysisResult.suggestedCategory && cat.name.toLowerCase() === analysisResult.suggestedCategory.toLowerCase()
                        );
                        transactionCategoryId = matchedCategory ? matchedCategory.id : (currentCategories.length > 0 ? currentCategories[0].id : '');

                    } else {
                        analysisError = "Konnte keine Daten aus der Rechnung extrahieren. Bitte versuchen Sie es mit einem klareren Bild.";
                        console.error("LLM response structure unexpected:", result);
                    }
                } catch (error) {
                    console.error("Fehler bei der Rechnungsanalyse:", error);
                    analysisError = "Fehler bei der Analyse der Rechnung: " + error.message;
                } finally {
                    analysisLoading = false;
                    updateInvoiceAnalysisUI();
                }
            };

            const saveAnalyzedTransaction = async () => {
                analysisError = '';

                const amount = parseFloat(transactionAmount);
                if (isNaN(amount) || amount <= 0) {
                    analysisError = "Bitte geben Sie einen g√ºltigen Betrag ein.";
                    updateInvoiceAnalysisUI(); return;
                }
                if (transactionDescription.trim() === '') {
                    analysisError = "Bitte geben Sie eine Beschreibung ein.";
                    updateInvoiceAnalysisUI(); return;
                }
                if (transactionCategoryId === '') {
                    analysisError = "Bitte w√§hlen Sie eine Kategorie aus.";
                    updateInvoiceAnalysisUI(); return;
                }
                const transactionDateTime = transactionDate ? new Date(transactionDate + 'T12:00:00') : new Date();

                analysisLoading = true;
                updateInvoiceAnalysisUI();

                try {
                    await addDoc(transactionsCollectionRef, {
                        amount: amount,
                        description: transactionDescription.trim(),
                        type: transactionType,
                        categoryId: transactionCategoryId,
                        createdAt: transactionDateTime,
                        userId: currentUserId,
                        source: 'invoice_analysis'
                    });
                    analysisError = "Transaktion erfolgreich gespeichert!";
                    selectedImageBase64 = null;
                    imageMimeType = null;
                    analysisResult = null;
                    transactionAmount = '';
                    transactionDescription = '';
                    transactionDate = '';
                    transactionCategoryId = currentCategories.length > 0 ? currentCategories[0].id : '';

                } catch (error) {
                    console.error("Fehler beim Speichern der analysierten Transaktion:", error);
                    analysisError = "Fehler beim Speichern der Transaktion: " + error.message;
                } finally {
                    analysisLoading = false;
                    updateInvoiceAnalysisUI();
                }
            };

            onSnapshot(query(categoriesCollectionRef), (snapshot) => {
                currentCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (transactionCategoryId === '' && currentCategories.length > 0) {
                    transactionCategoryId = currentCategories[0].id;
                }
                updateInvoiceAnalysisUI();
            }, (error) => {
                console.error("Fehler beim Abrufen der Kategorien f√ºr Rechnungsanalyse:", error);
                analysisError = "Fehler beim Laden der Kategorien.";
                updateInvoiceAnalysisUI();
            });

            updateInvoiceAnalysisUI();
        }

        // --- Globale Funktion zum Speichern der Dashboard-Einstellungen ---
        const handleSaveDashboardSettings = async () => {
            // Hier wird kein "loading" oder "errorMessage" √ºbergeben, da diese Funktion
            // direkt die globalen dashboardSettings aktualisiert und Firestore anspricht.
            // Die UI-Updates werden durch den onSnapshot-Listener von dashboardSettings ausgel√∂st.

            const toggleAddTransaction = document.getElementById('toggle-add-transaction');
            const toggleUpcomingPayments = document.getElementById('toggle-upcoming-payments');
            const toggleTopExpenses = document.getElementById('toggle-top-expenses');
            const toggleExpenseTrend = document.getElementById('toggle-expense-trend');
            const toggleRecentTransactions = document.getElementById('toggle-recent-transactions');

            if (!toggleAddTransaction || !toggleUpcomingPayments || !toggleTopExpenses || !toggleExpenseTrend || !toggleRecentTransactions) {
                console.error("Ein oder mehrere Dashboard-Umschaltelemente wurden beim Speicherversuch im DOM nicht gefunden!");
                // Hier k√∂nnte man eine globale Fehlermeldung setzen, die dann im UI angezeigt wird.
                return;
            }

            const newSettings = {
                showAddTransaction: toggleAddTransaction.checked,
                showUpcomingPayments: toggleUpcomingPayments.checked,
                showTopExpenses: toggleTopExpenses.checked,
                showExpenseTrend: toggleExpenseTrend.checked,
                showRecentTransactions: toggleRecentTransactions.checked,
            };

            console.log("Neue Einstellungen zum Speichern:", newSettings);

            try {
                if (!dashboardSettingsDocRef && currentUserId) {
                    dashboardSettingsDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/dashboardSettings`, 'userSettings');
                } else if (!currentUserId) {
                    console.error("Keine Benutzer-ID verf√ºgbar, kann Dashboard-Einstellungen nicht speichern.");
                    return;
                }

                await setDoc(dashboardSettingsDocRef, newSettings, { merge: true });
                console.log("Dashboard-Einstellungen erfolgreich in Firestore gespeichert.");
            } catch (error) {
                console.error("Fehler beim Speichern der Dashboard-Einstellungen:", error);
            }
        };


        // --- Initialisierung und Event Listener ---
        document.addEventListener('DOMContentLoaded', () => {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    currentUserId = user.uid;

                    // Initialisiere dashboardSettingsDocRef und setze den Listener hier
                    dashboardSettingsDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/dashboardSettings`, 'userSettings');

                    onSnapshot(dashboardSettingsDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            dashboardSettings = docSnap.data();
                            console.log("Dashboard settings loaded/updated from Firestore:", dashboardSettings);
                        } else {
                            dashboardSettings = {
                                showAddTransaction: true,
                                showUpcomingPayments: true,
                                showRecentTransactions: true,
                                showTopExpenses: true,
                                showExpenseTrend: true
                            };
                            console.log("Initializing default dashboard settings in Firestore:", dashboardSettings);
                            setDoc(dashboardSettingsDocRef, dashboardSettings, { merge: true }).catch(e => console.error("Fehler beim Speichern der Standard-Dashboard-Einstellungen:", e));
                        }
                        // Wichtig: Da dashboardSettings global ist, wird renderPage() oder jede andere
                        // Funktion, die dashboardSettings verwendet, die aktualisierten Werte beim n√§chsten
                        // Rendern verwenden. Ein expliziter renderPage() Aufruf hier w√ºrde zu einer
                        // Endlosschleife f√ºhren, wenn er nicht sorgf√§ltig behandelt wird.
                        // Die UI-Updates der jeweiligen Seiten werden durch ihre eigenen onSnapshot-Listener
                        // oder durch den Navigationsaufruf ausgel√∂st.
                        // F√ºr die Einstellungsseite, die die Checkboxen anzeigt, muss updateSettingsUI()
                        // aufgerufen werden, um die UI zu aktualisieren, sobald sich dashboardSettings √§ndert.
                        // Dies wird innerhalb von renderSettingsPage() durch den onSnapshot-Listener f√ºr recurringTransactions
                        // und categories implizit ausgel√∂st, da updateSettingsUI() dort aufgerufen wird.
                        // Um sicherzustellen, dass die Einstellungsseite sofort aktualisiert wird,
                        // wenn die Einstellungen ge√§ndert werden (z.B. von einer anderen Sitzung),
                        // k√∂nnte man hier einen expliziten Aufruf von renderPage('settings') in Betracht ziehen,
                        // aber das k√∂nnte zu unn√∂tigem Flackern f√ºhren.
                    }, (error) => {
                        console.error("Fehler beim Abrufen der Dashboard-Einstellungen:", error);
                    });

                    renderPage('dashboard');
                } else {
                    currentUser = null;
                    currentUserId = null;
                    dashboardSettings = {};
                    renderPage('login');
                }
                isAuthReady = true;
            });

            // Navigation Event Listener
            dashboardBtn.addEventListener('click', () => renderPage('dashboard'));
            categoriesBtn.addEventListener('click', () => renderPage('categories'));
            settingsBtn.addEventListener('click', () => renderPage('settings'));
            limitsBtn.addEventListener('click', () => renderPage('limits'));
            savingsGoalsBtn.addEventListener('click', () => renderPage('savings-goals'));
            invoiceAnalysisBtn.addEventListener('click', () => renderPage('invoice-analysis'));
            logoutBtn.addEventListener('click', async () => {
                await signOut(auth);
                currentUser = null;
                currentUserId = null;
                renderPage('login');
            });
        });
    </script>
</body>
</html>
